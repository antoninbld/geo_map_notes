<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Note</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Markdown -> HTML -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{
      /* Th√®me clair */
      --bg:#ffffff;
      --text:#1b1b1b;
      --muted:#6b7280;
      --code:#f6f8fa;
      --accent:#1e90ff;
      --card:#ffffff;
    }
    body.dark{
      /* Th√®me sombre */
      --bg:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --code:#0b1220;
      --accent:#60a5fa;
      --card:#111827;
    }

    html,body{ background:var(--bg); color:var(--text); }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      max-width: 820px;
      margin: 40px auto;
      padding: 0 22px;
      line-height: 1.65;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      transition: background .2s ease, color .2s ease;
    }

    a { color: var(--accent); }
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:18px;
    }
    .back-link{
      display:inline-block; padding:8px 14px;
      background:var(--accent); color:#fff; text-decoration:none; border-radius:8px;
      font-size:14px; box-shadow:0 2px 10px rgba(30,144,255,.25);
    }
    .back-link:hover{ filter:brightness(.95); }

    .theme-toggle{
      background:var(--card); color:var(--text); border:1px solid rgba(0,0,0,.1);
      padding:8px 12px; border-radius:8px; cursor:pointer; font-size:14px;
    }
    body.dark .theme-toggle{ border-color: rgba(255,255,255,.15); }

    hr{ border:0; height:1px; background:#e5e7eb; margin:24px 0; }
    body.dark hr{ background:#1f2937; }

    /* Titre issu du front-matter */
    #note-title{
      margin: 6px 0 14px;
      font-size: 26px;
      line-height: 1.25;
    }

    h1,h2,h3{ line-height:1.25; margin:1.6em 0 .6em; }
    pre, code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    pre{
      background:var(--code); padding:12px; border-radius:8px; overflow:auto;
      border:1px solid rgba(0,0,0,.06);
    }
    body.dark pre{ border-color: rgba(255,255,255,.06); }
    blockquote{
      border-left:4px solid #e5e7eb; padding:8px 12px; color:var(--muted);
      background:rgba(0,0,0,.02); border-radius:6px; margin:12px 0;
    }
    body.dark blockquote{ border-left-color:#334155; background:rgba(255,255,255,.04); }
    img{ max-width:100%; height:auto; border-radius:8px; }
  </style>
</head>
<body>
  <div class="topbar">
    <a href="index.html" class="back-link">‚¨Ö Retour √† la carte</a>
    <button id="toggleTheme" class="theme-toggle" type="button">üåô Mode sombre</button>
  </div>

  <!-- Titre extrait du front-matter (gras + italique) -->
  <div id="note-title" style="display:none;"><em><strong></strong></em></div>

  <div id="content">Chargement de la note‚Ä¶</div>

  <script>
    // ---- Pr√©f√©rence de th√®me (persist√©e) ----
    const savedTheme = localStorage.getItem('noteTheme');
    if (savedTheme === 'dark') document.body.classList.add('dark');
    const toggleBtn = document.getElementById('toggleTheme');
    const updateToggleLabel = () => {
      const dark = document.body.classList.contains('dark');
      toggleBtn.textContent = dark ? '‚òÄÔ∏è Mode clair' : 'üåô Mode sombre';
    };
    updateToggleLabel();
    toggleBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      localStorage.setItem('noteTheme', document.body.classList.contains('dark') ? 'dark' : 'light');
      updateToggleLabel();
    });

    // ---- R√©cup√©ration de l'ID de note ----
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    const $content = document.getElementById("content");
    const $titleWrap = document.getElementById("note-title");
    const $titleStrong = $titleWrap.querySelector('strong');

    // Extrait un front-matter YAML tr√®s simple (cl√©: valeur), et le retire du texte
    function parseAndStripFrontMatter(text){
      let meta = {};
      if (text.startsWith('---')) {
        const end = text.indexOf('\n---', 3);
        if (end !== -1) {
          const fm = text.slice(3, end).trim();         // contenu YAML entre les ---
          text = text.slice(end + 4).trimStart();       // le reste du document
          // Parsing minimal "cl√©: valeur" (une ligne par champ, sans objets imbriqu√©s)
          fm.split('\n').forEach(line => {
            const idx = line.indexOf(':');
            if (idx > -1) {
              const key = line.slice(0, idx).trim();
              let val = line.slice(idx + 1).trim();
              // enl√®ve guillemets √©ventuels
              if ((val.startsWith('"') && val.endsWith('"')) || (val.startsWith("'") && val.endsWith("'"))) {
                val = val.slice(1, -1);
              }
              meta[key] = val;
            }
          });
        }
      }
      return { meta, body: text };
    }

    async function loadNote(noteId){
      const src = `https://raw.githubusercontent.com/antoninbld/geo_map_notes/main/docs/notes/${noteId}.md`;
      const res = await fetch(src, { cache: "no-store" });
      if (!res.ok) throw new Error(`Note introuvable (HTTP ${res.status})`);
      const mdRaw = await res.text();

      // 1) Front-matter -> meta + corps markdown
      const { meta, body } = parseAndStripFrontMatter(mdRaw);

      // 2) Titre : gras + italique si pr√©sent
      if (meta.title && meta.title.trim()) {
        $titleStrong.textContent = meta.title.trim();
        $titleWrap.style.display = '';
      } else {
        $titleWrap.style.display = 'none';
      }

      // 3) Conversion Markdown -> HTML
      const html = marked.parse(body);
      $content.innerHTML = html;
    }

    (async () => {
      try{
        if (!id) throw new Error("Aucune note sp√©cifi√©e (?id=...)");
        await loadNote(id);
      }catch(err){
        $content.innerHTML = `<p style="color:#b91c1c;"><strong>Erreur :</strong> ${err.message}</p>
                              <p>Chemin attendu : <code>docs/notes/${id||'votre-id'}.md</code></p>`;
      }
    })();
  </script>
</body>
</html>
