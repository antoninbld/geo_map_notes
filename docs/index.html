<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte de mes notes (Vector)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { position: absolute; inset: 0; }
    .control-panel {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: rgba(255,255,255,0.9); backdrop-filter: blur(6px);
      border-radius: 12px; padding: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; font-size: 14px;
    }
    .control-panel label { display:block; margin:6px 0; cursor:pointer; }
  
    /* === POPUP STYLES === */
    .maplibregl-popup-content{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      padding:12px 16px;
      border-radius:12px;
      box-shadow:0 4px 16px rgba(0,0,0,0.2);
      max-width:300px;
      background:#fff;
    }
    .popup-title{
      font-size:16px;
      font-weight:700;
      margin-bottom:6px;
      color:#111;
    }
    .popup-meta{
      font-size:13px;
      color:#666;
      margin-bottom:10px;
    }
    .popup-summary{
      font-size:12px;
      line-height:1;
      margin-bottom:10px;
      color:#222;
    }
    .popup-link{
      display:inline-block;
      padding:6px 10px;
      font-size:13px;
      background:#1e90ff;
      color:#fff;
      border-radius:6px;
      text-decoration:none;
    }
    .popup-link:hover{ background:#1565c0; }

  </style>
</head>
<body>
  <div id="map"></div>

  <div class="control-panel">
    <div style="font-weight:600; margin-bottom:6px;">Fond de carte</div>
    <label><input type="radio" name="basemap" value="hybrid" checked> Satellite + fronti√®res (Hybrid)</label>
    <label><input type="radio" name="basemap" value="streets"> OSM classique (Streets)</label>
    <label><input type="radio" name="basemap" value="light"> Voyager-like (Light)</label>
    <label><input type="radio" name="basemap" value="dark"> Mode sombre (Dark)</label>
  </div>

  <script src="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.js"></script>
  <script>
    // üëâ Mets ta cl√© MapTiler ici
    const MAPTILER_KEY = "MLrpRZ0Wo2Dsvsj13UYN";

    // Styles MapTiler (vector)
    const STYLES = {
      hybrid: `https://api.maptiler.com/maps/hybrid/style.json?key=${MAPTILER_KEY}`,
      streets: `https://api.maptiler.com/maps/streets/style.json?key=${MAPTILER_KEY}`,
      light:   `https://api.maptiler.com/maps/basic/style.json?key=${MAPTILER_KEY}`, // clair
      dark:    `https://api.maptiler.com/maps/dataviz-dark/style.json?key=${MAPTILER_KEY}` // sombre
    };

    // Carte MapLibre
    const map = new maplibregl.Map({
      container: 'map',
      style: STYLES.hybrid,           // d√©faut : Satellite + fronti√®res
      center: [0, 20],                // lon, lat
      zoom: 2
    });

    // Contr√¥les zoom / rotation
    map.addControl(new maplibregl.NavigationControl({ showCompass: false }));

    // --- Masquer/Afficher les labels ---
    function setLabelVisibility(visible) {
      const style = map.getStyle();
      if (!style || !style.layers) return;
      style.layers.forEach(layer => {
        const isText = layer.type === 'symbol' && layer.layout && layer.layout['text-field'];
        const looksLikeLabel = /label|place|country|state|city|town|village/i.test(layer.id);
        if (isText || looksLikeLabel) {
          try { map.setLayoutProperty(layer.id, 'visibility', visible ? 'visible' : 'none'); } catch {}
        }
      });
    }

    // --- Gestion du s√©lecteur de fond ---
    document.querySelectorAll('input[name="basemap"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const choice = e.target.value;

        if (choice === 'hybrid') {
          map.setStyle(STYLES.hybrid);
          map.once('styledata', () => setLabelVisibility(true));
        }
        if (choice === 'streets') {
          map.setStyle(STYLES.streets);
          map.once('styledata', () => setLabelVisibility(true));
        }
        if (choice === 'light') {
          map.setStyle(STYLES.light);
          map.once('styledata', () => setLabelVisibility(true));
        }
        if (choice === 'dark') {
          map.setStyle(STYLES.dark);
          map.once('styledata', () => setLabelVisibility(true));
        }

        // R√©-appliquer nos points quand le style change
        map.once('load', () => addMarkersFromJSON());
      });
    });

    // --- Points depuis data.json ---
    let currentMarkers = [];
    function clearMarkers() {
      currentMarkers.forEach(m => m.remove());
      currentMarkers = [];
    }

    async function addMarkersFromJSON() {
      clearMarkers();
      try {
        const res = await fetch('data.json');
        const items = await res.json();
        const bounds = new maplibregl.LngLatBounds();

        items.forEach(item => {
          if (typeof item.lon === 'number' && typeof item.lat === 'number') {
            const el = document.createElement('div');
            el.style.width = '14px';
            el.style.height = '14px';
            el.style.borderRadius = '50%';
            el.style.background = '#1e90ff';
            el.style.border = '2px solid white';
            el.style.boxShadow = '0 1px 6px rgba(0,0,0,0.3)';
            el.title = item.title || '';

            const marker = new maplibregl.Marker({ element: el })
              .setLngLat([item.lon, item.lat])
              .addTo(map);

            const html = `
              <div>
                <div class="popup-title">${item.title || '(Sans titre)'}</div>
                ${item.locationName ? `<div class="popup-meta">üìç ${item.locationName}</div>` : ''}
                ${item.summary ? `<div class="popup-summary">${item.summary}</div>` : ''}
                ${item.noteUrl ? `<a class="popup-link" href="${item.noteUrl}" target="_blank" rel="noopener">Ouvrir la note</a>` : ''}
              </div>
            `;

            const popup = new maplibregl.Popup({ offset: 12 }).setHTML(html);
            marker.setPopup(popup);
            currentMarkers.push(marker);

            bounds.extend([item.lon, item.lat]);
          }
        });

        if (!bounds.isEmpty()) {
          if (items.length === 1) map.easeTo({ center: bounds.getCenter(), zoom: 8 });
          else map.fitBounds(bounds, { padding: 40, duration: 700 });
        }
      } catch (e) {
        console.error('Erreur chargement data.json', e);
      }
    }

    // Charger les points au d√©marrage
    map.on('load', () => addMarkersFromJSON());
  </script>
</body>
</html>
