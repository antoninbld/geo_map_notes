<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte interactive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }

    /* Panneau Map views + boutons recentrage (en haut √† gauche) */
    .basemap-control {
      position:absolute; top:10px; left:10px; z-index:10;
      background:#fff; border-radius:12px; padding:10px;
      box-shadow:0 4px 16px rgba(0,0,0,.15);
      font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-size:14px; width: 240px;
    }
    .basemap-control strong { display:block; margin-bottom:6px; }
    .basemap-control label { display:block; margin:6px 0; cursor:pointer; }
    .btn {
      display:inline-block; margin-top:6px; padding:8px 10px;
      background:#1e90ff; color:#fff; border:none; border-radius:8px;
      font-size:13px; cursor:pointer; width:100%; text-align:left;
      box-shadow:0 2px 8px rgba(30,144,255,.35);
    }
    .btn:hover { filter:brightness(.95); }

    /* Popup (carte) */
    .maplibregl-popup { max-width: 300px; font-family: system-ui, sans-serif; }
    .popup-title { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .popup-meta  { font-size: 13px; color: #666; margin-bottom: 6px; }
    .popup-link  { display:inline-block; margin-top:6px; font-size:13px; color:#1e90ff; text-decoration:none; }
    .popup-link:hover { text-decoration: underline; }

    /* Bouton Filtres int√©gr√© au groupe de contr√¥les (en haut √† droite) */
    .maplibregl-ctrl.filters-ctrl .filters-btn{
      width:30px; height:30px; display:flex; align-items:center; justify-content:center;
      font-size:14px; background:#fff; border:none; cursor:pointer;
    }

    /* Panneau de filtres (pop-up) en haut √† droite */
    .filters-panel{
      position:absolute; top:60px; right:10px; z-index:10;
      width:280px; max-height:60vh; overflow:auto;
      background:#fff; border-radius:12px; padding:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.18); font-family:system-ui, sans-serif; font-size:14px;
      display:none;
    }
    .filters-panel h3{ margin:0 0 8px; font-size:16px; }
    .filters-panel .row{ margin:8px 0; }
    .filters-panel input[type="text"]{ width:100%; padding:8px; border:1px solid #ddd; border-radius:8px; }
    .filters-panel .tags{ display:flex; flex-wrap:wrap; gap:6px; }
    .filters-panel .tag{
      display:flex; align-items:center; gap:6px; padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px;
    }
    .filters-actions{ display:flex; gap:8px; margin-top:10px; }
    .filters-actions button{
      flex:1; padding:8px; border:none; border-radius:8px; cursor:pointer;
    }
    .filters-apply{ background:#1e90ff; color:#fff; }
    .filters-reset{ background:#f3f4f6; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Panneau Map Views + Recentrer -->
  <div class="basemap-control">
    <strong>Map views</strong>
    <label><input type="radio" name="basemap" value="hybrid"> Satellite</label>
    <label><input type="radio" name="basemap" value="streets"> Streets</label>
    <label><input type="radio" name="basemap" value="light" checked> Light</label>
    <label><input type="radio" name="basemap" value="dark"> Dark</label>

    <button id="recenterEurope" class="btn" type="button">Recentrer Europe</button>
    <button id="recenterUSA" class="btn" type="button">Recentrer √âtats-Unis</button>
  </div>

  <!-- Panneau Filtres (pop-up) -->
  <div id="filtersPanel" class="filters-panel">
    <h3>Filtres</h3>
    <div class="row">
      <label>Recherche</label>
      <input type="text" id="filterQuery" placeholder="Titre, lieu, r√©sum√©‚Ä¶" />
    </div>
    <div class="row">
      <label>Tags</label>
      <div id="tagsBox" class="tags"></div>
    </div>
    <div class="filters-actions">
      <button class="filters-apply" id="applyFilters">Appliquer</button>
      <button class="filters-reset" id="resetFilters">R√©initialiser</button>
    </div>
  </div>

  <script>
    // üîë Mets ta cl√© MapTiler ici
    const MAPTILER_KEY = "MLrpRZ0Wo2Dsvsj13UYN";

    // Styles MapTiler (vector)
    const STYLES = {
      hybrid: `https://api.maptiler.com/maps/hybrid/style.json?key=${MAPTILER_KEY}`,
      streets:`https://api.maptiler.com/maps/streets/style.json?key=${MAPTILER_KEY}`,
      light:  `https://api.maptiler.com/maps/basic/style.json?key=${MAPTILER_KEY}`, // clair (par d√©faut)
      dark:   `https://api.maptiler.com/maps/dataviz-dark/style.json?key=${MAPTILER_KEY}` // sombre
    };

    // üéØ Vues par d√©faut
    const DEFAULT_ZOOM   = 4.2;       // m√™me zoom pour EU & USA
    const EUROPE_CENTER  = [10, 50];  // lon, lat
    const USA_CENTER     = [-98.5, 39.8];

    // Carte
    const map = new maplibregl.Map({
      container: 'map',
      style: STYLES.light,   // ‚úÖ Light par d√©faut
      center: EUROPE_CENTER, // ‚úÖ Europe au d√©marrage
      zoom:   DEFAULT_ZOOM
    });

    // Contr√¥les zoom (en haut √† droite)
    map.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'top-right');

    // Bouton "Filtres" √† c√¥t√© du +/-
    class FilterControl {
      onAdd(map){
        this._map = map;
        const group = document.createElement('div');
        group.className = 'maplibregl-ctrl maplibregl-ctrl-group filters-ctrl';

        const btn = document.createElement('button');
        btn.className = 'filters-btn';
        btn.type = 'button';
        btn.title = 'Filtres';
        btn.textContent = 'Filtres';
        btn.addEventListener('click', () => {
          const panel = document.getElementById('filtersPanel');
          panel.style.display = panel.style.display === 'none' || !panel.style.display ? 'block' : 'none';
        });

        group.appendChild(btn);
        this._container = group;
        return group;
      }
      onRemove(){
        this._container.remove();
        this._map = undefined;
      }
    }
    map.addControl(new FilterControl(), 'top-right');

    // Labels visibles apr√®s changement de style
    function setLabelVisibility(visible) {
      const style = map.getStyle();
      if (!style || !style.layers) return;
      style.layers.forEach(layer => {
        const isText = layer.type === 'symbol' && layer.layout && layer.layout['text-field'];
        const looksLikeLabel = /label|place|country|state|city|town|village/i.test(layer.id);
        if (isText || looksLikeLabel) {
          try { map.setLayoutProperty(layer.id, 'visibility', visible ? 'visible' : 'none'); } catch {}
        }
      });
    }

    // Recentrages
    function recenterEurope() {
      map.easeTo({ center: EUROPE_CENTER, zoom: DEFAULT_ZOOM, duration: 600 });
    }
    function recenterUSA() {
      map.easeTo({ center: USA_CENTER, zoom: DEFAULT_ZOOM, duration: 600 });
    }
    document.getElementById('recenterEurope').addEventListener('click', recenterEurope);
    document.getElementById('recenterUSA').addEventListener('click', recenterUSA);

    // Raccourcis clavier : E (Europe), U (USA)
    window.addEventListener('keydown', (e) => {
      const key = e.key.toLowerCase();
      if (key === 'e') recenterEurope();
      if (key === 'u') recenterUSA();
    });

    // Changement de fond
    document.querySelectorAll('input[name="basemap"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const choice = e.target.value;
        map.setStyle(STYLES[choice]);
        map.once('styledata', () => setLabelVisibility(true));
        map.once('load', () => {
          // r√©applique les marqueurs et r√©applique les filtres apr√®s reload du style
          addMarkersFromJSON().then(applyFilters);
        });
      });
    });

    // === Donn√©es & Marqueurs & Filtres ===
    let allData = [];      // toutes les entr√©es JSON (charg√©es une fois)
    let allMarkers = [];   // { item, marker }
    let allTags = new Set();

    async function addMarkersFromJSON() {
      // charge data.json une seule fois
      if (allData.length === 0) {
        try {
          const res = await fetch('data.json', { cache: 'no-store' });
          allData = await res.json();
        } catch (e) {
          console.error('Erreur chargement data.json', e);
          return;
        }
      }

      // nettoie anciens marqueurs
      allMarkers.forEach(({marker}) => marker.remove());
      allMarkers = [];
      allTags.clear();

      // cr√©e les marqueurs
      allData.forEach(item => {
        if (typeof item.lon === 'number' && typeof item.lat === 'number') {
          // STYLE du marqueur (rouge + bordure rouge fonc√©)
          const el = document.createElement('div');
          el.style.width = '14px';
          el.style.height = '14px';
          el.style.borderRadius = '50%';
          el.style.background = 'red';             // centre
          el.style.border = '2px solid darkred';   // contour
          el.style.boxShadow = '0 1px 6px rgba(0,0,0,0.3)';
          el.title = item.title || '';

          const marker = new maplibregl.Marker({ element: el })
            .setLngLat([item.lon, item.lat])
            .addTo(map);

          const html = `
            <div style="width:240px;">
              <div class="popup-title">${item.title || '(Sans titre)'}</div>
              ${item.locationName ? `<div class="popup-meta">üìç ${item.locationName}</div>` : ''}
              ${item.summary ? `<div style="font-size:12px; line-height:1.4; font-style:italic; color:#444;">${item.summary}</div>` : ''}
              ${item.noteUrl ? `<a class="popup-link" href="${item.noteUrl}" target="_blank" rel="noopener">üìÑ Ouvrir la note</a>` : ''}
            </div>
          `;
          const popup = new maplibregl.Popup({ offset: 12 }).setHTML(html);
          marker.setPopup(popup);

          allMarkers.push({ item, marker });

          // collecte des tags
          if (Array.isArray(item.tags)) item.tags.forEach(t => allTags.add(String(t)));
        }
      });

      // construit la liste de tags (si des tags existent)
      buildTagCheckboxes();
    }

    function buildTagCheckboxes(){
      const box = document.getElementById('tagsBox');
      if (!box) return;
      box.innerHTML = '';
      if (allTags.size === 0) {
        box.innerHTML = '<div style="color:#777; font-size:13px;">Aucun tag d√©tect√©</div>';
        return;
      }
      Array.from(allTags).sort((a,b)=>a.localeCompare(b)).forEach(tag => {
        const label = document.createElement('label');
        label.className = 'tag';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.name = 'tag';
        cb.value = tag;
        const txt = document.createElement('span');
        txt.textContent = tag;
        label.appendChild(cb);
        label.appendChild(txt);
        box.appendChild(label);
      });
    }

    function applyFilters(){
      const q = (document.getElementById('filterQuery')?.value || '').toLowerCase().trim();
      const selected = Array.from(document.querySelectorAll('input[name="tag"]:checked')).map(i => i.value);

      allMarkers.forEach(({ item, marker }) => {
        // filtre texte
        let visible = true;
        if (q) {
          const hay = [
            item.title || '',
            item.locationName || '',
            item.summary || ''
          ].join(' ').toLowerCase();
          visible = hay.includes(q);
        }

        // filtre tags (ET logique)
        if (visible && selected.length) {
          const itags = Array.isArray(item.tags) ? item.tags.map(String) : [];
          visible = selected.every(t => itags.includes(t));
        }

        marker.getElement().style.display = visible ? '' : 'none';
      });
    }

    function resetFilters(){
      const q = document.getElementById('filterQuery');
      if (q) q.value = '';
      document.querySelectorAll('input[name="tag"]:checked').forEach(cb => cb.checked = false);
      // r√©affiche tout
      allMarkers.forEach(({marker}) => marker.getElement().style.display = '');
    }

    // Branche les boutons du panneau filtres
    document.getElementById('applyFilters')?.addEventListener('click', applyFilters);
    document.getElementById('resetFilters')?.addEventListener('click', resetFilters);

    // D√©marrage
    map.on('load', () => addMarkersFromJSON());
  </script>
</body>
</html>
