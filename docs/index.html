<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte interactive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }

    /* Panneau Map views + boutons recentrage (en haut √† gauche) */
    .basemap-control {
      position:absolute; top:10px; left:10px; z-index:10;
      background:#fff; border-radius:12px; padding:10px;
      box-shadow:0 4px 16px rgba(0,0,0,.15);
      font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-size:14px; width: 240px;
    }
    .basemap-control strong { display:block; margin-bottom:6px; }
    .basemap-control label { display:block; margin:6px 0; cursor:pointer; }
    .btn {
      display:inline-block; margin-top:6px; padding:8px 10px;
      background:#1e90ff; color:#fff; border:none; border-radius:8px;
      font-size:13px; cursor:pointer; width:100%; text-align:left;
      box-shadow:0 2px 8px rgba(30,144,255,.35);
    }
    .btn:hover { filter:brightness(.95); }

    /* Popup (carte) */
    .maplibregl-popup { max-width: 300px; font-family: system-ui, sans-serif; }
    .popup-title { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .popup-meta  { font-size: 13px; color: #666; margin-bottom: 6px; }
    .popup-link  { display:inline-block; margin-top:6px; font-size:13px; color:#1e90ff; text-decoration:none; }
    .popup-link:hover { text-decoration: underline; }

    /* Bouton Filtres int√©gr√© au groupe de contr√¥les (en haut √† droite) */
    .maplibregl-ctrl.filters-ctrl .filters-btn{
      min-width:60px; height:30px; display:flex; align-items:center; justify-content:center;
      font-size:14px; background:#fff; border:none; cursor:pointer;
    }

    /* Panneau de filtres (pop-up) en haut √† droite */
    .filters-panel{
      position:absolute; top:115px; right:10px; z-index:10;
      width:360px; max-height:60vh; overflow:auto;
      background:#fff; border-radius:12px; padding:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.18); font-family:system-ui, sans-serif; font-size:14px;
      display:none;
    }
    .s-panel h3{ margin:0 0 8px; font-size:16px; }
    .s-panel .row{ margin:8px 0; }
    .s-panel input[type="text"]{ width:100%; padding:8px; border:1px solid #ddd; border-radius:8px; }
    .s-panel .tags{ display:flex; flex-wrap:wrap; gap:6px; }
    .s-panel .tag{
      display:flex; align-items:center; gap:6px; padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px;
    }
    .filters-actions{ display:flex; gap:8px; margin-top:10px; }
    .filters-actions button{
      flex:1; padding:8px; border:none; border-radius:8px; cursor:pointer;
    }
    .filters-apply{ background:#1e90ff; color:#fff; }
    .filters-reset{ background:#f3f4f6; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Panneau Map Views + Recentrer -->
  <div class="basemap-control">
    <strong>Map views</strong>
    <label><input type="radio" name="basemap" value="hybrid"> Satellite</label>
    <label><input type="radio" name="basemap" value="streets" checked> Streets</label> <!-- ‚úÖ checked ici -->
    <label><input type="radio" name="basemap" value="light"> Light</label>
    <label><input type="radio" name="basemap" value="dark"> Dark</label>

    <button id="recenterEurope" class="btn" type="button">Recentrer Europe</button>
    <button id="recenterUSA" class="btn" type="button">Recentrer √âtats-Unis</button>
  </div>

  <!-- Panneau Filtres (pop-up) -->
  <div id="filtersPanel" class="filters-panel">
    <h3>Filtres</h3>
    <div class="row">
      <label>Recherche</label>
      <input type="text" id="filterQuery" placeholder="Titre, lieu, r√©sum√©‚Ä¶" />
    </div>
    <div class="row">
      <label>Tags</label>
      <div id="tagsBox" class="tags"></div>
    </div>
    <div class="filters-actions">

    <div class="row">
      <label>Pays</label>
      <select id="filterCountry" multiple size="6" style="width:100%; border:1px solid #ddd; border-radius:8px; padding:6px;">
        <!-- rempli dynamiquement -->
      </select>
      <div style="display:flex; gap:8px; margin-top:6px;">
        <button id="selectAllCountries"  class="filters-reset" type="button" style="flex:1;">Tout s√©lectionner</button>
        <button id="clearAllCountries"   class="filters-reset" type="button" style="flex:1;">Tout d√©s√©lectionner</button>
      </div>
    </div>
      
      <button class="filters-apply" id="applyFilters">Appliquer</button>
      <button class="filters-reset" id="resetFilters">R√©initialiser</button>
    </div>
  </div>

  <script>
    // üîë Mets ta cl√© MapTiler ici
    const MAPTILER_KEY = "MLrpRZ0Wo2Dsvsj13UYN";

    // Styles MapTiler (vector)
    const STYLES = {
      hybrid: `https://api.maptiler.com/maps/hybrid/style.json?key=${MAPTILER_KEY}`,
      streets:`https://api.maptiler.com/maps/streets/style.json?key=${MAPTILER_KEY}`,
      light:  `https://api.maptiler.com/maps/basic/style.json?key=${MAPTILER_KEY}`, // clair (par d√©faut)
      dark:   `https://api.maptiler.com/maps/dataviz-dark/style.json?key=${MAPTILER_KEY}` // sombre
    };

    // === Liens fa√ßon Obsidian entre notes ===
    const NOTE_RAW_BASE = 'https://raw.githubusercontent.com/antoninbld/geo_map_notes/main/docs/notes';
    const idToItem = new Map();     // id -> item (depuis data.json)
    const linksCache = new Map();   // id -> [linkedId, ...]
    let linksSourceReady = false;   // source/layer pour les traits
    
    // üéØ Vues par d√©faut
    const DEFAULT_ZOOM   = 3.8;       // m√™me zoom pour EU & USA
    const EUROPE_CENTER  = [10, 50];  // lon, lat
    const USA_CENTER     = [-98.5, 39.8];

    // Carte
    const map = new maplibregl.Map({
      container: 'map',
      style: STYLES.streets,   // ‚úÖ Streets par d√©faut
      center: EUROPE_CENTER, // ‚úÖ Europe au d√©marrage
      zoom:   DEFAULT_ZOOM
    });

    // Contr√¥les zoom (en haut √† droite)
    map.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'top-right');

    // Bouton "Filtres" √† c√¥t√© du +/-
    class FilterControl {
      onAdd(map){
        this._map = map;
        const group = document.createElement('div');
        group.className = 'maplibregl-ctrl maplibregl-ctrl-group filters-ctrl';

        const btn = document.createElement('button');
        btn.className = 'filters-btn';
        btn.type = 'button';
        btn.title = 'Filtres';
        btn.textContent = 'Filtres';
        btn.addEventListener('click', () => {
          const panel = document.getElementById('filtersPanel');
          panel.style.display = panel.style.display === 'none' || !panel.style.display ? 'block' : 'none';
        });

        // Ferme le panneau filtres si on clique ailleurs
        document.addEventListener('click', (e) => {
          const panel = document.getElementById('filtersPanel');
          const btn = document.querySelector('.filters-btn');
          if (!panel || !btn) return;
          if (panel.style.display === 'block' && !panel.contains(e.target) && !btn.contains(e.target)) {
            panel.style.display = 'none';
          }
        });
        
        group.appendChild(btn);
        this._container = group;
        return group;
      }
      onRemove(){
        this._container.remove();
        this._map = undefined;
      }
    }
    map.addControl(new FilterControl(), 'top-right');

    // Labels visibles apr√®s changement de style
    function setLabelVisibility(visible) {
      const style = map.getStyle();
      if (!style || !style.layers) return;
      style.layers.forEach(layer => {
        const isText = layer.type === 'symbol' && layer.layout && layer.layout['text-field'];
        const looksLikeLabel = /label|place|country|state|city|town|village/i.test(layer.id);
        if (isText || looksLikeLabel) {
          try { map.setLayoutProperty(layer.id, 'visibility', visible ? 'visible' : 'none'); } catch {}
        }
      });
    }

    // === Pays: bbox & helpers ===
    let countriesBbox = {}; // nom -> [minLon, minLat, maxLon, maxLat]
    
    async function loadCountries(){
      try{
        const res = await fetch('countries-bbox.json', { cache: 'no-store' });
        countriesBbox = await res.json();
        buildCountrySelect();
      }catch(e){
        console.error('Erreur chargement countries-bbox.json', e);
      }
    }
    
    function buildCountrySelect(){
      const sel = document.getElementById('filterCountry');
      if (!sel) return;
      sel.innerHTML = '';
      Object.keys(countriesBbox).sort((a,b)=>a.localeCompare(b)).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
      });
    }

    // Permet de cocher/d√©cocher les pays par simple clic (sans Ctrl/‚åò)
    const countrySel = document.getElementById('filterCountry');
    if (countrySel) {
      countrySel.addEventListener('mousedown', (e) => {
        const opt = e.target;
        if (opt.tagName === 'OPTION') {
          e.preventDefault();            // √©vite la s√©lection exclusive
          opt.selected = !opt.selected;  // toggle
          countrySel.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
    }

    function pointInBbox(lon, lat, bbox){
      const [minX, minY, maxX, maxY] = bbox;
      return lon >= minX && lon <= maxX && lat >= minY && lat <= maxY;
    }
  
    // Recentrages
    function recenterEurope() {
      map.easeTo({ center: EUROPE_CENTER, zoom: DEFAULT_ZOOM, duration: 600 });
    }
    function recenterUSA() {
      map.easeTo({ center: USA_CENTER, zoom: DEFAULT_ZOOM, duration: 600 });
    }
    document.getElementById('recenterEurope').addEventListener('click', recenterEurope);
    document.getElementById('recenterUSA').addEventListener('click', recenterUSA);

    // Raccourcis clavier : E (Europe), U (USA)
    window.addEventListener('keydown', (e) => {
      const key = e.key.toLowerCase();
      if (key === 'e') recenterEurope();
      if (key === 'u') recenterUSA();
    });

    // Changement de fond
    document.querySelectorAll('input[name="basemap"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const choice = e.target.value;
        map.setStyle(STYLES[choice]);
        map.once('styledata', () => setLabelVisibility(true));
        map.once('load', () => {
        // 1) Recr√©e les marqueurs et filtres
        addMarkersFromJSON().then(applyFilters);
      
        // 2) ‚úÖ Recr√©e la couche des liens et r√©-affiche le dernier √©tat
        linksSourceReady = false;   // force la recr√©ation
        ensureLinksLayer();
        if (window.__lastLinksState) {
          drawLinksFrom(window.__lastLinksState.id, window.__lastLinksState.links);
        }
      });

        });
      });
    });

    // === Donn√©es & Marqueurs & Filtres ===
    let allData = [];      // toutes les entr√©es JSON (charg√©es une fois)
    let allMarkers = [];   // { item, marker }
    let allTags = new Set();

    function extractWikiLinks(mdText){
      const found = new Set();
      const re = /\[\[([^\]\|]+)(?:\|[^\]]+)?\]\]/g;
      let m;
      while ((m = re.exec(mdText)) !== null) {
        const id = m[1].trim();
        if (id) found.add(id);
      }
      return Array.from(found);
    }
    
    async function getOutgoingLinks(noteId){
      if (linksCache.has(noteId)) return linksCache.get(noteId);
      const url = `${NOTE_RAW_BASE}/${encodeURIComponent(noteId)}.md`;
      const res = await fetch(url, { cache:'no-store' });
      if (!res.ok) { linksCache.set(noteId, []); return []; }
      const md = await res.text();
      const ids = extractWikiLinks(md).filter(id => idToItem.has(id));
      linksCache.set(noteId, ids);
      return ids;
    }
    
    function ensureLinksLayer(){
      if (linksSourceReady) return;
      if (!map.getSource('note-links')) {
        map.addSource('note-links', { type:'geojson', data:{ type:'FeatureCollection', features:[] } });
      }
      if (!map.getLayer('note-links-line')) {
        map.addLayer({
          id:'note-links-line',
          type:'line',
          source:'note-links',
          paint:{ 'line-color':'#1e90ff', 'line-width':2, 'line-opacity':0.8 }
        });
      }
      linksSourceReady = true;
    }
    
    function drawLinksFrom(noteId, linkedIds){
      ensureLinksLayer();
      const from = idToItem.get(noteId);
      if (!from) return;
      const features = [];
      linkedIds.forEach(lid => {
        const to = idToItem.get(lid);
        if (!to) return;
        features.push({
          type:'Feature',
          geometry:{ type:'LineString', coordinates:[[from.lon, from.lat],[to.lon, to.lat]] },
          properties:{ from: noteId, to: lid }
        });
      });
      const src = map.getSource('note-links');
      src.setData({ type:'FeatureCollection', features });
    }
    
    function clearLinks(){
      const src = map.getSource('note-links');
      if (src) src.setData({ type:'FeatureCollection', features:[] });
    } 
    
    async function addMarkersFromJSON() {
      // charge data.json une seule fois
      if (allData.length === 0) {
        try {
          const res = await fetch('data.json', { cache: 'no-store' });
          allData = await res.json();
        } catch (e) {
          console.error('Erreur chargement data.json', e);
          return;
        }
      }

      // 3.3 ‚Äî index rapide id -> item (sert aux liens entre notes)
      idToItem.clear();
      allData.forEach(it => { if (it && it.id) idToItem.set(it.id, it); });

      
      // nettoie anciens marqueurs
      allMarkers.forEach(({marker}) => marker.remove());
      allMarkers = [];
      allTags.clear();

      // cr√©e les marqueurs
      allData.forEach(item => {
        if (typeof item.lon === 'number' && typeof item.lat === 'number') {
          // STYLE du marqueur (rouge + bordure rouge fonc√©)
          const el = document.createElement('div');
          el.style.width = '14px';
          el.style.height = '14px';
          el.style.borderRadius = '50%';
          el.style.background = 'red';             // centre
          el.style.border = '2px solid darkred';   // contour
          el.style.boxShadow = '0 1px 6px rgba(0,0,0,0.3)';
          el.title = item.title || '';

          const marker = new maplibregl.Marker({ element: el })
            .setLngLat([item.lon, item.lat])
            .addTo(map);


          const html = `
            <div style="width:260px;">
              <div class="popup-title">${item.title || '(Sans titre)'}</div>
              ${item.locationName ? `<div class="popup-meta">üìç ${item.locationName}</div>` : ''}
              ${item.summary ? `<div style="font-size:12px; line-height:1.4; font-style:italic; color:#444;">${item.summary}</div>` : ''}
          
              <!-- Zone qui affichera les liens sortants d√©tect√©s dans la note -->
              <div id="links-${item.id}" style="margin-top:8px; font-size:13px; color:#333;">
                <em style="color:#666;">Liens sortants‚Ä¶</em>
              </div>
          
              <a class="popup-link" 
                 href="${item.noteUrl || `note.html?id=${encodeURIComponent(item.id)}`}" 
                 target="_blank" rel="noopener">üìÑ Ouvrir la note</a>
            </div>
          `;
          const popup = new maplibregl.Popup({ offset: 12 }).setHTML(html);
          marker.setPopup(popup);
          
          // Quand la popup s‚Äôouvre (ou au clic sur le marqueur), on calcule & dessine les liens
          const onOpen = async () => {
            // R√©cup√®re les ids li√©s pr√©sents en [[...]] dans le .md
            const links = await getOutgoingLinks(item.id);
          
            // Affiche la liste dans la popup (si toujours ouverte)
            const box = document.getElementById(`links-${item.id}`);
            if (box) {
              if (links.length === 0) {
                box.innerHTML = `<span style="color:#888;">Aucun lien sortant</span>`;
              } else {
                box.innerHTML = `
                  <div style="font-weight:600; margin-bottom:4px;">Liens sortants</div>
                  <ul style="margin:0; padding-left:18px;">
                    ${links.map(lid => {
                      const it = idToItem.get(lid);
                      const lbl = it?.title || lid;
                      return `<li><a href="note.html?id=${encodeURIComponent(lid)}" target="_blank" rel="noopener">${lbl}</a></li>`;
                    }).join('')}
                  </ul>
                  <div style="margin-top:6px;">
                    <button type="button" style="padding:6px 8px; border:1px solid #e5e7eb; border-radius:6px; background:#fff; cursor:pointer;">
                      üîé Voir les li√©s
                    </button>
                  </div>
                `;
          
                // Branche le bouton pour recadrer sur le groupe (source + li√©s)
                const btn = box.querySelector('button');
                if (btn) {
                  btn.onclick = () => {
                    const b = new maplibregl.LngLatBounds();
                    b.extend([item.lon, item.lat]);
                    links.forEach(lid => { const t = idToItem.get(lid); if (t) b.extend([t.lon, t.lat]); });
                    map.fitBounds(b, { padding: 80, duration: 650 });
                  };
                }
              }
            }
          
            // Trace les segments sur la carte
            drawLinksFrom(item.id, links);
            // M√©morise le dernier √©tat pour r√©-afficher apr√®s changement de style
            window.__lastLinksState = { id: item.id, links };

          };
          
          // D√©clenche au clic sur le marqueur et √† l‚Äôouverture de la popup
          el.addEventListener('click', onOpen);
          try { popup.on('open', onOpen); } catch {}
          
          // Efface les traits √† la fermeture
          try { popup.on('close', clearLinks); } catch {}
          

          allMarkers.push({ item, marker });

          // collecte des tags
          if (Array.isArray(item.tags)) item.tags.forEach(t => allTags.add(String(t)));
        }
      });

      // construit la liste de tags (si des tags existent)
      buildTagCheckboxes();
    }

    function buildTagCheckboxes(){
      const box = document.getElementById('tagsBox');
      if (!box) return;
      box.innerHTML = '';
      if (allTags.size === 0) {
        box.innerHTML = '<div style="color:#777; font-size:13px;">Aucun tag d√©tect√©</div>';
        return;
      }
      Array.from(allTags).sort((a,b)=>a.localeCompare(b)).forEach(tag => {
        const label = document.createElement('label');
        label.className = 'tag';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.name = 'tag';
        cb.value = tag;
        const txt = document.createElement('span');
        txt.textContent = tag;
        label.appendChild(cb);
        label.appendChild(txt);
        box.appendChild(label);
      });
    }

    function applyFilters(){
      const q = (document.getElementById('filterQuery')?.value || '').toLowerCase().trim();
      const selected = Array.from(document.querySelectorAll('input[name="tag"]:checked')).map(i => i.value);
    
      // üîΩ Pays s√©lectionn√©s (multiselect)
      const sel = document.getElementById('filterCountry');
      const selectedCountries = sel ? Array.from(sel.selectedOptions).map(o => o.value) : [];
    
      allMarkers.forEach(({ item, marker }) => {
        let visible = true;
    
        // Filtre texte
        if (q) {
          const hay = [item.title||'', item.locationName||'', item.summary||''].join(' ').toLowerCase();
          visible = hay.includes(q);
        }
    
        // Filtre tags (ET logique)
        if (visible && selected.length) {
          const itags = Array.isArray(item.tags) ? item.tags.map(String) : [];
          visible = selected.every(t => itags.includes(t));
        }
    
        // üîΩ Filtre pays (OU logique entre pays s√©lectionn√©s)
        if (visible && selectedCountries.length) {
          const lon = item.lon, lat = item.lat;
          visible = selectedCountries.some(countryName => {
            const bbox = countriesBbox[countryName];
            return bbox ? pointInBbox(lon, lat, bbox) : false;
          });
        }
    
        marker.getElement().style.display = visible ? '' : 'none';
      });
    }
    
    function resetFilters(){
      // R√©initialiser recherche
      const q = document.getElementById('filterQuery');
      if (q) q.value = '';
    
      // R√©initialiser tags
      document.querySelectorAll('input[name="tag"]:checked').forEach(cb => cb.checked = false);
    
      // R√©initialiser pays
      const sel = document.getElementById('filterCountry');
      if (sel) Array.from(sel.options).forEach(o => o.selected = false);
    
      // R√©afficher tous les marqueurs
      allMarkers.forEach(({marker}) => marker.getElement().style.display = '');
    
      // Fermer le panneau
      const panel = document.getElementById('filtersPanel');
      if (panel) panel.style.display = 'none';
    
      // üîΩ Recentrer sur l‚ÄôEurope
      map.easeTo({ center: [10, 50], zoom: 4.2, duration: 600 });
    }

    
    function zoomToVisibleMarkers(){
      const visibles = allMarkers.filter(({marker}) => marker.getElement().style.display !== 'none');
      if (visibles.length === 0) return; // rien √† recadrer
    
      if (visibles.length === 1) {
        const [lon, lat] = visibles[0].marker.getLngLat().toArray();
        map.easeTo({ center: [lon, lat], zoom: 8, duration: 600 });
        return;
      }
    
      const bounds = new maplibregl.LngLatBounds();
      visibles.forEach(({marker}) => bounds.extend(marker.getLngLat()));
      map.fitBounds(bounds, { padding: 60, duration: 700 });
    }
    
    // Branche les boutons du panneau filtres
    document.getElementById('applyFilters')?.addEventListener('click', () => {
      applyFilters();
      zoomToVisibleMarkers(); // üîé recadre sur les r√©sultats filtr√©s
      document.getElementById('filtersPanel').style.display = 'none'; // ferme le panneau
    });
    document.getElementById('resetFilters')?.addEventListener('click', resetFilters);
    
    // Pays: tout s√©lectionner / tout d√©s√©lectionner
    document.getElementById('selectAllCountries')?.addEventListener('click', () => {
      const sel = document.getElementById('filterCountry');
      if (!sel) return;
      Array.from(sel.options).forEach(o => o.selected = true);
    });
    document.getElementById('clearAllCountries')?.addEventListener('click', () => {
      const sel = document.getElementById('filterCountry');
      if (!sel) return;
      Array.from(sel.options).forEach(o => o.selected = false);
    });
    
    // D√©marrage
    map.on('load', () => {
      addMarkersFromJSON();
      ensureLinksLayer(); // üîß pr√©pare la couche des liens d√®s le d√©but
    });
    loadCountries();

    // 3.5 ‚Äî Effacer les traits si on clique ailleurs que sur un marqueur
    map.on('click', (e) => {
      const path = e.originalEvent?.composedPath?.() || [];
      const clickedMarkerEl = path.find(n => n && n.classList && n.classList.contains('maplibregl-marker'));
      if (!clickedMarkerEl) {
        clearLinks();
      }
    });
    </script>
    </body>
    </html>

