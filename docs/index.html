<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte interactive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }

    .basemap-control {
      position:absolute; top:10px; left:10px; z-index:10;
      background:#fff; border-radius:12px; padding:10px;
      box-shadow:0 4px 16px rgba(0,0,0,.15);
      font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-size:14px;
    }
    .basemap-control strong { display:block; margin-bottom:6px; }
    .basemap-control label { display:block; margin:6px 0; cursor:pointer; }

    .btn {
      display:inline-block; margin-top:6px; padding:8px 10px;
      background:#1e90ff; color:#fff; border:none; border-radius:8px;
      font-size:13px; cursor:pointer;
      box-shadow:0 2px 8px rgba(30,144,255,.35);
      width:100%;
      text-align:left;
    }
    .btn:hover { filter:brightness(.95); }

    .maplibregl-popup { max-width: 300px; font-family: system-ui, sans-serif; }
    .popup-title { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .popup-meta  { font-size: 13px; color: #666; margin-bottom: 6px; }
    .popup-link  { display:inline-block; margin-top:6px; font-size:13px; color:#1e90ff; text-decoration:none; }
    .popup-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="basemap-control">
    <strong>Map views</strong>
    <label><input type="radio" name="basemap" value="hybrid"> Satellite</label>
    <label><input type="radio" name="basemap" value="streets"> Streets</label>
    <label><input type="radio" name="basemap" value="light" checked> Light</label>
    <label><input type="radio" name="basemap" value="dark"> Dark</label>
  
    <button id="recenterEurope" class="btn" type="button">Recentrer Europe</button>
    <button id="recenterUSA" class="btn" type="button">Recentrer √âtats-Unis</button>
  </div>

  <script>
    // üö® Mets ta cl√© MapTiler ici
    const MAPTILER_KEY = "MLrpRZ0Wo2Dsvsj13UYN";

    // Styles MapTiler (vector)
    const STYLES = {
      hybrid: `https://api.maptiler.com/maps/hybrid/style.json?key=${MAPTILER_KEY}`,
      streets:`https://api.maptiler.com/maps/streets/style.json?key=${MAPTILER_KEY}`,
      light:  `https://api.maptiler.com/maps/basic/style.json?key=${MAPTILER_KEY}`, // clair
      dark:   `https://api.maptiler.com/maps/dataviz-dark/style.json?key=${MAPTILER_KEY}` // sombre
    };

    // üéØ Vues par d√©faut
    const DEFAULT_ZOOM   = 4.2;       // m√™me zoom pour les deux boutons
    const EUROPE_CENTER  = [10, 50];  // lon, lat
    const USA_CENTER     = [-98.5, 39.8];

    // Carte
    const map = new maplibregl.Map({
      container: 'map',
      style: STYLES.light,   // ‚úÖ Light par d√©faut
      center: EUROPE_CENTER, // ‚úÖ Europe au d√©marrage
      zoom:   DEFAULT_ZOOM
    });

    // Contr√¥les zoom
    map.addControl(new maplibregl.NavigationControl({ showCompass: false }));

    // Labels visibles apr√®s changement de style
    function setLabelVisibility(visible) {
      const style = map.getStyle();
      if (!style || !style.layers) return;
      style.layers.forEach(layer => {
        const isText = layer.type === 'symbol' && layer.layout && layer.layout['text-field'];
        const looksLikeLabel = /label|place|country|state|city|town|village/i.test(layer.id);
        if (isText || looksLikeLabel) {
          try { map.setLayoutProperty(layer.id, 'visibility', visible ? 'visible' : 'none'); } catch {}
        }
      });
    }

    // Recentrages
    function recenterEurope() {
      map.easeTo({ center: EUROPE_CENTER, zoom: DEFAULT_ZOOM, duration: 600 });
    }
    function recenterUSA() {
      map.easeTo({ center: USA_CENTER, zoom: DEFAULT_ZOOM, duration: 600 });
    }
    document.getElementById('recenterEurope').addEventListener('click', recenterEurope);
    document.getElementById('recenterUSA').addEventListener('click', recenterUSA);

    // Raccourcis clavier : E (Europe), U (USA)
    window.addEventListener('keydown', (e) => {
      const key = e.key.toLowerCase();
      if (key === 'e') recenterEurope();
      if (key === 'u') recenterUSA();
    });

    // Changement de fond
    document.querySelectorAll('input[name="basemap"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const choice = e.target.value;
        map.setStyle(STYLES[choice]);
        map.once('styledata', () => setLabelVisibility(true));
        map.once('load', () => addMarkersFromJSON()); // r√©applique les marqueurs
      });
    });

    // Marqueurs depuis data.json
    let currentMarkers = [];
    function clearMarkers() {
      currentMarkers.forEach(m => m.remove());
      currentMarkers = [];
    }

    async function addMarkersFromJSON() {
      clearMarkers();
      try {
        const res = await fetch('data.json');
        const items = await res.json();

        items.forEach(item => {
          if (typeof item.lon === 'number' && typeof item.lat === 'number') {
            // style du marqueur (modifiable)
            const el = document.createElement('div');
            el.style.width = '14px';
            el.style.height = '14px';
            el.style.borderRadius = '50%';
            el.style.background = 'red';              // fond rouge
            el.style.border = '2px solid darkred';    // bordure rouge fonc√©
            el.style.boxShadow = '0 1px 6px rgba(0,0,0,0.3)';
            el.title = item.title || '';

            const marker = new maplibregl.Marker({ element: el })
              .setLngLat([item.lon, item.lat])
              .addTo(map);

            const html = `
              <div style="width:240px;">
                <div class="popup-title">${item.title || '(Sans titre)'}</div>
                ${item.locationName ? `<div class="popup-meta">üìç ${item.locationName}</div>` : ''}
                ${item.summary ? `<div style="font-size:12px; line-height:1.4; font-style:italic; color:#444;">${item.summary}</div>` : ''}
                ${item.noteUrl ? `<a class="popup-link" href="${item.noteUrl}" target="_blank" rel="noopener">üìÑ Ouvrir la note</a>` : ''}
              </div>
            `;
            const popup = new maplibregl.Popup({ offset: 12 }).setHTML(html);
            marker.setPopup(popup);
            currentMarkers.push(marker);
          }
        });

        // Pas de fitBounds : on garde la vue choisie (Europe/USA)
      } catch (e) {
        console.error('Erreur chargement data.json', e);
      }
    }

    map.on('load', () => addMarkersFromJSON());
  </script>
</body>
</html>
