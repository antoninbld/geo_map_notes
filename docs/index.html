<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte interactive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MapLibre -->
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

  <!-- Marked (pour le panneau interne Markdown) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root { --recap-lines: 2; }

    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }

    /* Panneau Map views + boutons recentrage (en haut √† gauche) */
    .basemap-control {
      position:absolute; top:10px; left:10px; z-index:10;
      background:#fff; border-radius:12px; padding:10px;
      box-shadow:0 4px 16px rgba(0,0,0,.15);
      font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-size:14px; width: 240px;
    }
    .basemap-control strong { display:block; margin-bottom:6px; }
    .basemap-control label { display:block; margin:6px 0; cursor:pointer; }
    .btn {
      display:inline-block; margin-top:6px; padding:8px 10px;
      background:#1e90ff; color:#fff; border:none; border-radius:8px;
      font-size:13px; cursor:pointer; width:100%; text-align:left;
      box-shadow:0 2px 8px rgba(30,144,255,.35);
    }
    .btn:hover { filter:brightness(.95); }

    /* Popup (carte) */
    .maplibregl-popup { max-width: 300px; font-family: system-ui, sans-serif; }
    .popup-title { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .popup-meta  { font-size: 13px; color: #666; margin-bottom: 6px; }
    .popup-link  { display:inline-block; margin-top:6px; font-size:13px; color:#1e90ff; text-decoration:none; }
    .popup-link:hover { text-decoration: underline; }

    /* Bouton Filtres int√©gr√© au groupe de contr√¥les (en haut √† droite) */
    .maplibregl-ctrl.filters-ctrl .filters-btn{
      min-width:60px; height:30px; display:flex; align-items:center; justify-content:center;
      font-size:14px; background:#fff; border:none; cursor:pointer;
    }

    /* Panneau de filtres (pop-up) en haut √† droite */
    .filters-panel{
      position:absolute; top:115px; right:10px; z-index:10;
      width:360px; max-height:60vh; overflow:auto;
      background:#fff; border-radius:12px; padding:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.18); font-family:system-ui, sans-serif; font-size:14px;
      display:none;
    }
    .s-panel h3{ margin:0 0 8px; font-size:16px; }
    .s-panel .row{ margin:8px 0; }
    .s-panel input[type="text"]{ width:100%; padding:8px; border:1px solid #ddd; border-radius:8px; }
    .s-panel .tags{ display:flex; flex-wrap:wrap; gap:6px; }
    .s-panel .tag{
      display:flex; align-items:center; gap:6px; padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px;
    }
    .filters-actions{ display:flex; gap:8px; margin-top:10px; }
    .filters-actions button{
      flex:1; padding:8px; border:none; border-radius:8px; cursor:pointer;
    }
    .filters-apply{ background:#1e90ff; color:#fff; }
    .filters-reset{ background:#f3f4f6; }

    /* Panneau interne (lecture des notes) */
    .internal-link {
      text-decoration: none;
      border-bottom: 1px dashed #1e90ff;
    }
    .internal-link:hover { text-decoration: underline; }

    /* Liens internes style Obsidian (panel + r√©sum√©s) */
    .internal-link{ text-decoration:none; border-bottom:1px dashed #1e90ff; }
    .internal-link:hover{ text-decoration:underline; }

    /* R√©cap: line-clamp CSS (√©tat r√©duit) */
    #npRecap.clamped {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: var(--recap-lines);
      overflow: hidden;
    }
    /* Lien de bascule */
    #npRecapToggle {
      cursor: pointer;
      display: inline-block;
      margin-top: 4px;
      text-decoration: underline;
      font-style: italic;
      user-select: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Panneau de lecture interne -->
  <div id="notePanel" style="position:absolute;right:10px;top:10px;width:400px;max-height:88vh;overflow:auto;background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.18);padding:0;display:none;z-index:12;font-family:system-ui;">
    <!-- En-t√™te jaune -->
    <div id="npHeader" style="background:#facc15;padding:10px 12px;border-radius:12px 12px 0 0;border-bottom:1px solid #0f172a22; position:sticky; top:0; z-index:20;box-shadow:0 4px 8px rgba(0,0,0,.35);">
      <!-- Bouton croix en haut-droite -->
      <button id="npClose" type="button" aria-label="Fermer"
              style="position:absolute; top:8px; right:10px;
                     width:26px; height:26px;
                     display:flex; align-items:center; justify-content:center;
                     border:none; border-radius:6px;
                     background:#dc2626; color:#fff; cursor:pointer;
                     box-shadow:0 1px 4px rgba(0,0,0,.15);">
        ‚úñ
      </button>
      <div id="npTitle" style="font-size:16px;font-weight:700;">Titre</div>

      <!-- Lieu avec üìç -->
      <div id="npMeta" style="font-size:12px;opacity:.9;display:flex;align-items:center;gap:6px;margin-top:4px;">
        <span id="npIcon" style="font-size:14px;line-height:1">üìç</span>
        <span id="npPlace">Pays, ville</span>
      </div>

      <!-- Date SOUS la localisation -->
      <div id="npDate" style="font-size:12px;opacity:.8;margin-top:2px; margin-left:20px;">6 octobre 1981</div>

      <!-- Phrase r√©cap (optionnelle) -->
      <div id="npRecap" style="font-size:13px;margin-top:6px; font-weight:600; font-style:italic;"></div>
      <a id="npRecapToggle" href="#" style="display:none;"></a>
    </div>


    <!-- Corps clair (marges homog√®nes) -->
    <div id="npWrapper" style="padding:6px 6px;">
      <div id="npCard" style="border:1px solid #0f172a22;border-radius:10px;padding:10px;background:#fef9c3;">
        <!-- Petite phrase avant la note (optionnelle) -->
        <div id="npSummary" style="font-size:14px;line-height:1.55;margin-bottom:8px;"></div>
        <!-- Markdown complet de la note -->
        <div id="npMd" style="font-size:14px;line-height:1.55;"></div>
      </div>

      <!-- Liens sortants -->
      <div id="npLinksWrap" style="margin-top:10px;">
        <div style="font-weight:700;margin:8px 0 6px;">Liens sortants</div>
        <div id="npLinks" style="font-size:14px;"></div>
        <div style="margin-top:8px;display:flex;gap:8px;">
          <button id="npFit"  type="button" style="padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px;background:#fff;cursor:pointer;">üîé Voir les li√©s</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Panneau Map Views + Recentrer -->
  <div class="basemap-control">
    <strong>Map views</strong>
    <label><input type="radio" name="basemap" value="hybrid"> Satellite</label>
    <label><input type="radio" name="basemap" value="streets" checked> Streets</label>
    <label><input type="radio" name="basemap" value="light"> Light</label>
    <label><input type="radio" name="basemap" value="dark"> Dark</label>

    <button id="recenterEurope" class="btn" type="button">Recentrer Europe</button>
    <button id="recenterUSA" class="btn" type="button">Recentrer √âtats-Unis</button>
  </div>

  <!-- Panneau Filtres (pop-up) -->
  <div id="filtersPanel" class="filters-panel s-panel">
    <h3>Filtres</h3>

    <!-- Recherche -->
    <div class="row">
      <label>Recherche</label>
      <input type="text" id="filterQuery" placeholder="Titre, lieu, r√©sum√©‚Ä¶" />
    </div>

    <!-- Tags -->
    <div class="row">
      <label>Tags</label>
      <div id="tagsBox" class="tags"></div>
    </div>

    <!-- Pays -->
    <div class="row">
      <label>Pays</label>
      <select id="filterCountry" multiple size="6" style="width:100%; border:1px solid #ddd; border-radius:8px; padding:6px;">
        <!-- rempli dynamiquement -->
      </select>
      <div style="display:flex; gap:8px; margin-top:6px;">
        <button id="selectAllCountries"  class="filters-reset" type="button" style="flex:1;">Tout s√©lectionner</button>
        <button id="clearAllCountries"   class="filters-reset" type="button" style="flex:1;">Tout d√©s√©lectionner</button>
      </div>
    </div>

    <!-- Actions -->
    <div class="row">
      <div class="filters-actions">
        <button class="filters-apply" id="applyFilters" type="button">Appliquer</button>
        <button class="filters-reset" id="resetFilters" type="button">R√©initialiser</button>
      </div>
    </div>
  </div>

  <script>
    // üîë Mets ta cl√© MapTiler ici
    const MAPTILER_KEY = "MLrpRZ0Wo2Dsvsj13UYN"; // remplace si besoin

    const UI_CONFIG = {
      panel: {
        width: "400px",
        marginRight: "10px",
        marginTop: "10px",
        background: "#fff",
        shadow: "0 8px 24px rgba(0,0,0,.18)",
        borderRadius: "12px"
      },
      header: {
        background: "#facc15",
        textColor: "#000",
        titleSize: "16px",
        locationIcon: "üìç",
        dateIndent: "20px",
        dateFormat: { day: "numeric", month: "long", year: "numeric" },
        recapStyle: "font-weight:600; font-style:italic;",
        recapMaxLines: 2,
        recapMoreLabel: " [‚Ä¶]",
        recapLessLabel: " ‚Ü• r√©duire"
      },
      card: {
        background: "#fef9c3",
        border: "1px solid #0f172a22",
        borderRadius: "10px",
        outerPadding: "8px 10px",
        innerPadding: "10px",
        fontSize: "14px",
        lineHeight: "1.55"
      },
      links: {
        sectionTitle: "Liens sortants",
        internalLinkColor: "#1e90ff",
        internalLinkUnderline: "dashed"
      },
      buttons: {
        fitText: "üîé Voir les li√©s",
        closeText: "‚úñ Fermer",
        background: "#fff",
        borderRadius: "6px"
      }
    };

    // Cr√©e/actualise une balise <style> d√©di√©e aux overrides UI
    function setUIStyle(css){
      let tag = document.getElementById('ui-overrides');
      if (!tag) {
        tag = document.createElement('style');
        tag.id = 'ui-overrides';
        document.head.appendChild(tag);
      }
      tag.textContent = css;
    }

    // Applique le UI_CONFIG sur le panneau d√©j√† pr√©sent dans le DOM
    function applyUIConfig(){
      const P = UI_CONFIG.panel;
      const H = UI_CONFIG.header;
      const C = UI_CONFIG.card;
      const L = UI_CONFIG.links;
      const B = UI_CONFIG.buttons;

      setUIStyle(`
        #notePanel{ width:${P.width}; right:${P.marginRight}; top:${P.marginTop}; background:${P.background}; box-shadow:${P.shadow}; border-radius:${P.borderRadius}; }
        #npHeader{ background:${H.background}; color:${H.textColor}; }
        #npTitle{ font-size:${H.titleSize}; }
        #npDate{ margin-left:${H.dateIndent}; }
        #npRecap{ ${H.recapStyle} }
        #npWrapper{ padding:${C.outerPadding}; }
        #npCard{ background:${C.background}; border:${C.border}; border-radius:${C.borderRadius}; padding:${C.innerPadding}; font-size:${C.fontSize}; line-height:${C.lineHeight}; }
        .internal-link{ text-decoration: none; border-bottom: 1px ${L.internalLinkUnderline} ${L.internalLinkColor}; color: inherit; }
        .internal-link:hover{ text-decoration: underline; }
        #npLinksWrap button{ background:${B.background}; border-radius:${B.borderRadius}; }
      `);

      const icon = document.getElementById('npIcon');
      if (icon) icon.textContent = H.locationIcon;
      const linksTitle = document.querySelector('#npLinksWrap > div:first-child');
      if (linksTitle) linksTitle.textContent = L.sectionTitle;
      const btnFit  = document.getElementById('npFit');
      if (btnFit) btnFit.textContent = B.fitText;

      // nombre de lignes clamp
      document.documentElement.style.setProperty('--recap-lines', String(H.recapMaxLines || 2));
    }

    // === Helpers Obsidian/panneau ===
    function parseAndStripFrontMatter(text){
      let meta = {};
      if (text.startsWith('---')) {
        const end = text.indexOf('\n---', 3);
        if (end !== -1) {
          const fm = text.slice(3, end).trim();
          text = text.slice(end + 4).trimStart();
          fm.split('\n').forEach(line => {
            const idx = line.indexOf(':');
            if (idx > -1) {
              const key = line.slice(0, idx).trim();
              let val = line.slice(idx + 1).trim();
              if ((val.startsWith('"') && val.endsWith('"')) || (val.startsWith("'") && val.endsWith("'"))) {
                val = val.slice(1, -1);
              }
              meta[key] = val;
            }
          });
        }
      }
      return { meta, body: text };
    }

    function transformWikiLinks(md){
      return md.replace(/\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/g, (m, rawId, label) => {
        const id = String(rawId||'').trim();
        if (!id) return m;
        const txt = String(label||id).trim();
        return \`[\${txt}](note.html?id=\${encodeURIComponent(id)})\`;
      });
    }

    // Parse robuste : "YYYY-MM-DD", "DD/MM/YYYY", "DD-MM-YYYY" -> Date
    function parseDateSmart(s){
      if (!s) return null;
      const str = String(s).trim();
      let m = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);           // YYYY-MM-DD
      if (m) return new Date(+m[1], +m[2]-1, +m[3]);
      m = str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);           // DD/MM/YYYY
      if (m) return new Date(+m[3], +m[2]-1, +m[1]);
      m = str.match(/^(\d{2})-(\d{2})-(\d{4})$/);               // DD-MM-YYYY
      if (m) return new Date(+m[3], +m[2]-1, +m[1]);
      return null;
    }
    function formatDateByConfig(s){
      const d = parseDateSmart(s);
      if (!d) return s || '';
      return new Intl.DateTimeFormat('fr-FR', UI_CONFIG.header.dateFormat).format(d);
    }

    // --- [[...]] cliquables dans les r√©sum√©s (summary de data.json) ---
    function renderWikiLinksInline(text){
      if (!text) return '';
      return text.replace(/\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/g, (m, rawId, label) => {
        const id = String(rawId).trim();
        const txt = (label || id).trim();
        return \`<a href="note.html?id=\${encodeURIComponent(id)}" target="_blank" rel="noopener" class="internal-link">\${txt}</a>\`;
      });
    }

    // === Liens fa√ßon Obsidian entre notes ===
    function extractWikiLinks(mdText){
      const found = new Set();
      const re = /\[\[([^\]\|]+)(?:\|[^\]]+)?\]\]/g;
      let m;
      while ((m = re.exec(mdText)) !== null) {
        const id = m[1].trim();
        if (id) found.add(id);
      }
      return Array.from(found);
    }

    // === Nouveau: gestion du r√©cap via CSS + toggle ===
    function updateRecapToggleLabel(collapsed) {
      const t = document.getElementById('npRecapToggle');
      if (!t) return;
      const H = (window.UI_CONFIG && UI_CONFIG.header) || {};
      t.textContent = collapsed ? (H.recapMoreLabel || ' [‚Ä¶]') : (H.recapLessLabel || ' ‚Ü• r√©duire');
    }
    function setupRecapToggle() {
      const wrap = document.getElementById('npRecap');
      const t = document.getElementById('npRecapToggle');
      if (!wrap || !t) return;

      // Si pas de texte: masquer le toggle
      const hasText = !!wrap.textContent.trim();
      t.style.display = hasText ? 'inline-block' : 'none';
      if (!hasText) return;

      // √âtat initial: r√©duit
      wrap.classList.add('clamped');
      updateRecapToggleLabel(true);

      t.onclick = (e) => {
        e.preventDefault();
        const collapsed = wrap.classList.toggle('clamped'); // true si clamped apr√®s toggle
        updateRecapToggleLabel(collapsed);
      };
    }
    function setRecapText(text) {
      const wrap = document.getElementById('npRecap');
      if (!wrap) return;
      wrap.innerHTML = text ? renderWikiLinksInline(text) : '';
      setupRecapToggle();
    }

    // === Liens entre notes (traits) ===
    const NOTE_RAW_BASE = 'https://raw.githubusercontent.com/antoninbld/geo_map_notes/main/docs/notes';
    const idToItem = new Map();
    const linksCache = new Map();
    let linksSourceReady = false;
    window.__lastLinksState = null;

    const DEFAULT_ZOOM = 3.8;
    const EUROPE_CENTER = [10, 50];
    const USA_CENTER = [-98.5, 39.8];

    const STYLES = {
      hybrid: \`https://api.maptiler.com/maps/hybrid/style.json?key=\${MAPTILER_KEY}\`,
      streets:\`https://api.maptiler.com/maps/streets/style.json?key=\${MAPTILER_KEY}\`,
      light:  \`https://api.maptiler.com/maps/basic/style.json?key=\${MAPTILER_KEY}\`,
      dark:   \`https://api.maptiler.com/maps/dataviz-dark/style.json?key=\${MAPTILER_KEY}\`
    };

    const map = new maplibregl.Map({
      container: 'map',
      style: STYLES.streets,
      center: EUROPE_CENTER,
      zoom: DEFAULT_ZOOM
    });
    map.on('error', (e) => console.error('Map error:', e && (e.error || e)));
    map.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'top-right');

    class FilterControl {
      onAdd(map){
        this._map = map;
        const group = document.createElement('div');
        group.className = 'maplibregl-ctrl maplibregl-ctrl-group filters-ctrl';

        const btn = document.createElement('button');
        btn.className = 'filters-btn';
        btn.type = 'button';
        btn.title = 'Filtres';
        btn.textContent = 'Filtres';
        btn.addEventListener('click', () => {
          const panel = document.getElementById('filtersPanel');
          panel.style.display = panel.style.display === 'none' || !panel.style.display ? 'block' : 'none';
        });

        document.addEventListener('click', (e) => {
          const panel = document.getElementById('filtersPanel');
          const btn = document.querySelector('.filters-btn');
          if (!panel || !btn) return;
          if (panel.style.display === 'block' && !panel.contains(e.target) && !btn.contains(e.target)) {
            panel.style.display = 'none';
          }
        });

        group.appendChild(btn);
        this._container = group;
        return group;
      }
      onRemove(){ this._container.remove(); this._map = undefined; }
    }
    map.addControl(new FilterControl(), 'top-right');

    function setLabelVisibility(visible) {
      const style = map.getStyle();
      if (!style || !style.layers) return;
      style.layers.forEach(layer => {
        const isText = layer.type === 'symbol' && layer.layout && layer.layout['text-field'];
        const looksLikeLabel = /label|place|country|state|city|town|village/i.test(layer.id);
        if (isText || looksLikeLabel) {
          try { map.setLayoutProperty(layer.id, 'visibility', visible ? 'visible' : 'none'); } catch {}
        }
      });
    }

    // === Pays: bbox & helpers ===
    let countriesBbox = {};
    async function loadCountries(){
      try{
        const res = await fetch('countries-bbox.json', { cache: 'no-store' });
        countriesBbox = await res.json();
        buildCountrySelect();
      }catch(e){
        console.error('Erreur chargement countries-bbox.json', e);
      }
    }
    function buildCountrySelect(){
      const sel = document.getElementById('filterCountry');
      if (!sel) return;
      sel.innerHTML = '';
      Object.keys(countriesBbox).sort((a,b)=>a.localeCompare(b)).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
      });
    }
    const countrySel = document.getElementById('filterCountry');
    if (countrySel) {
      countrySel.addEventListener('mousedown', (e) => {
        const opt = e.target;
        if (opt.tagName === 'OPTION') {
          e.preventDefault();
          opt.selected = !opt.selected;
          countrySel.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
    }
    function pointInBbox(lon, lat, bbox){
      const [minX, minY, maxX, maxY] = bbox;
      return lon >= minX && lon <= maxX && lat >= minY && lat <= maxY;
    }

    // Recentrages & clavier
    function recenterEurope() { map.easeTo({ center: EUROPE_CENTER, zoom: DEFAULT_ZOOM, duration: 600 }); }
    function recenterUSA() { map.easeTo({ center: USA_CENTER, zoom: DEFAULT_ZOOM, duration: 600 }); }
    document.getElementById('recenterEurope').addEventListener('click', recenterEurope);
    document.getElementById('recenterUSA').addEventListener('click', recenterUSA);
    window.addEventListener('keydown', (e) => {
      const key = e.key.toLowerCase();
      if (key === 'e') recenterEurope();
      if (key === 'u') recenterUSA();
    });

    // Changement de fond
    document.querySelectorAll('input[name="basemap"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const choice = e.target.value;
        map.setStyle(STYLES[choice]);

        const rebuild = () => {
          addMarkersFromJSON().then(applyFilters);
          linksSourceReady = false;
          ensureLinksLayer();
          if (window.__lastLinksState) {
            const { id, links } = window.__lastLinksState;
            drawLinksFrom(id, links);
          }
        };
        map.once('load', rebuild);
        map.once('styledata', rebuild);
      });
    });

    // === Donn√©es & Marqueurs & Filtres ===
    let allData = [];
    let allMarkers = [];
    let allTags = new Set();

    async function addMarkersFromJSON() {
      if (allData.length === 0) {
        try {
          const res = await fetch('data.json', { cache: 'no-store' });
          allData = await res.json();
        } catch (e) {
          console.error('Erreur chargement data.json', e);
          return;
        }
      }

      idToItem.clear();
      allMarkers.forEach(({marker}) => marker.remove());
      allMarkers = [];
      allTags.clear();

      allData.forEach(item => {
        if (item && item.id) idToItem.set(item.id, item);
        // collecter tags -> affichage filtres
        if (Array.isArray(item.tags)) {
          item.tags.forEach(t => { if (t && String(t).trim()) allTags.add(String(t).trim()); });
        }

        if (typeof item.lon === 'number' && typeof item.lat === 'number') {
          const el = document.createElement('div');
          el.style.width = '14px';
          el.style.height = '14px';
          el.style.borderRadius = '50%';
          el.style.background = 'red';
          el.style.border = '2px solid darkred';
          el.style.boxShadow = '0 1px 6px rgba(0,0,0,0.3)';
          el.title = item.title || '';

          const marker = new maplibregl.Marker({ element: el })
            .setLngLat([item.lon, item.lat])
            .addTo(map);

          el.addEventListener('click', async () => {
            await openSummaryInPanel(item.id);
          });

          allMarkers.push({ item, marker });
        }
      });

      buildTagCheckboxes();
    }

    function buildTagCheckboxes(){
      const box = document.getElementById('tagsBox');
      if (!box) return;
      box.innerHTML = '';
      if (allTags.size === 0) {
        box.innerHTML = '<div style="color:#777; font-size:13px;">Aucun tag d√©tect√©</div>';
        return;
      }
      Array.from(allTags).sort((a,b)=>a.localeCompare(b)).forEach(tag => {
        const label = document.createElement('label');
        label.className = 'tag';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.name = 'tag';
        cb.value = tag;
        const txt = document.createElement('span');
        txt.textContent = tag;
        label.appendChild(cb);
        label.appendChild(txt);
        box.appendChild(label);
      });
    }

    function applyFilters(){
      const q = (document.getElementById('filterQuery')?.value || '').toLowerCase().trim();
      const selected = Array.from(document.querySelectorAll('input[name="tag"]:checked')).map(i => i.value);
      const sel = document.getElementById('filterCountry');
      const selectedCountries = sel ? Array.from(sel.selectedOptions).map(o => o.value) : [];

      allMarkers.forEach(({ item, marker }) => {
        let visible = true;

        if (q) {
          const hay = [item.title||'', item.locationName||'', item.summary||'', item.recap||''].join(' ').toLowerCase();
          visible = hay.includes(q);
        }

        if (visible && selected.length) {
          const itags = Array.isArray(item.tags) ? item.tags.map(String) : [];
          visible = selected.every(t => itags.includes(t));
        }

        if (visible && selectedCountries.length) {
          const lon = item.lon, lat = item.lat;
          visible = selectedCountries.some(countryName => {
            const bbox = countriesBbox[countryName];
            return bbox ? pointInBbox(lon, lat, bbox) : false;
          });
        }

        marker.getElement().style.display = visible ? '' : 'none';
      });
    }

    function resetFilters(){
      const q = document.getElementById('filterQuery');
      if (q) q.value = '';
      document.querySelectorAll('input[name="tag"]:checked').forEach(cb => cb.checked = false);
      const sel = document.getElementById('filterCountry');
      if (sel) Array.from(sel.options).forEach(o => o.selected = false);
      allMarkers.forEach(({marker}) => marker.getElement().style.display = '');
      const panel = document.getElementById('filtersPanel');
      if (panel) panel.style.display = 'none';
      map.easeTo({ center: EUROPE_CENTER, zoom: DEFAULT_ZOOM, duration: 600 });
    }

    function zoomToVisibleMarkers(){
      const visibles = allMarkers.filter(({marker}) => marker.getElement().style.display !== 'none');
      if (visibles.length === 0) return;
      if (visibles.length === 1) {
        const [lon, lat] = visibles[0].marker.getLngLat().toArray();
        map.easeTo({ center: [lon, lat], zoom: 8, duration: 600 });
        return;
      }
      const bounds = new maplibregl.LngLatBounds();
      visibles.forEach(({marker}) => bounds.extend(marker.getLngLat()));
      map.fitBounds(bounds, { padding: 60, duration: 700 });
    }

    document.getElementById('applyFilters')?.addEventListener('click', () => {
      applyFilters();
      zoomToVisibleMarkers();
      document.getElementById('filtersPanel').style.display = 'none';
    });
    document.getElementById('resetFilters')?.addEventListener('click', resetFilters);

    document.getElementById('selectAllCountries')?.addEventListener('click', () => {
      const sel = document.getElementById('filterCountry');
      if (!sel) return;
      Array.from(sel.options).forEach(o => o.selected = true);
    });
    document.getElementById('clearAllCountries')?.addEventListener('click', () => {
      const sel = document.getElementById('filterCountry');
      if (!sel) return;
      Array.from(sel.options).forEach(o => o.selected = false);
    });

    map.on('click', (e) => {
      const path = e.originalEvent?.composedPath?.() || [];
      const clickedMarkerEl = path.find(n => n && n.classList && n.classList.contains('maplibregl-marker'));
      if (!clickedMarkerEl) { clearLinks(); }
    });

    // === Fermeture du panneau (‚úñ + √âchap) ===
    (function setupNotePanelClose(){
      const btn = document.getElementById('npClose');
      if (!btn) return;
      const closePanel = () => {
        const panel = document.getElementById('notePanel');
        if (panel) panel.style.display = 'none';
        if (typeof clearLinks === 'function') clearLinks();
      };
      btn.addEventListener('click', closePanel);
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePanel(); });
    })();

    // === Liens: source & dessin ===
    function ensureLinksLayer(){
      const add = () => {
        if (!map.getSource('note-links')) {
          map.addSource('note-links', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
        }
        if (!map.getLayer('note-links-line')) {
          map.addLayer({ id: 'note-links-line', type: 'line', source: 'note-links',
            paint: { 'line-color': '#1e90ff', 'line-width': 2, 'line-opacity': 0.85 } });
        }
        try { map.moveLayer('note-links-line'); } catch {}
        linksSourceReady = true;
      };
      if (!map.isStyleLoaded()) {
        const onceAdd = () => { add(); map.off('styledata', onceAdd); };
        map.once('load', add);
        map.on('styledata', onceAdd);
        return;
      }
      add();
    }
    function drawLinksFrom(noteId, linkedIds){
      if (!map.getSource('note-links') || !map.getLayer('note-links-line')) { ensureLinksLayer(); }
      const from = idToItem.get(noteId);
      if (!from) return;
      const features = [];
      (linkedIds || []).forEach(lid => {
        const to = idToItem.get(lid);
        if (!to) return;
        features.push({ type:'Feature',
          geometry:{ type:'LineString', coordinates:[[from.lon, from.lat],[to.lon, to.lat]] },
          properties:{ from: noteId, to: lid } });
      });
      const src = map.getSource('note-links');
      src.setData({ type:'FeatureCollection', features });
    }
    function clearLinks(){
      const src = map.getSource('note-links');
      if (src) src.setData({ type:'FeatureCollection', features:[] });
    }

    // === Ouverture panel depuis un marqueur ===
    async function getOutgoingLinks(noteId){
      if (linksCache.has(noteId)) return linksCache.get(noteId);
      const url = \`\${NOTE_RAW_BASE}/\${encodeURIComponent(noteId)}.md\`;
      const res = await fetch(url, { cache:'no-store' });
      if (!res.ok) { linksCache.set(noteId, []); return []; }
      const md = await res.text();
      const ids = extractWikiLinks(md).filter(id => idToItem.has(id));
      linksCache.set(noteId, ids);
      return ids;
    }

    async function openSummaryInPanel(noteId){
      const item   = idToItem.get(noteId);
      const $panel = document.getElementById('notePanel');
      const $title = document.getElementById('npTitle');
      const $place = document.getElementById('npPlace');
      const $date  = document.getElementById('npDate');
      const $sum   = document.getElementById('npSummary');
      const $md    = document.getElementById('npMd');
      const $links = document.getElementById('npLinks');
      const $fit   = document.getElementById('npFit');

      if (!item) {
        $title.textContent = noteId;
        $place.textContent = '';
        $date.textContent  = '';
        setRecapText('');
        $sum.innerHTML     = '';
        $md.innerHTML      = '';
        $links.innerHTML   = '';
        $panel.style.display = 'block';
        return;
      }

      $title.textContent = item.title || noteId;
      $place.textContent = item.locationName || '';
      $date.textContent  = '';

      // recap depuis data.json (prioritaire, sinon vide pour le moment)
      setRecapText(item.recap || '');

      $sum.innerHTML = item.summary ? renderWikiLinksInline(item.summary) : '';

      let links = [];
      try {
        const url = \`\${NOTE_RAW_BASE}/\${encodeURIComponent(noteId)}.md\`;
        const res = await fetch(url, { cache:'no-store' });
        if (res.ok) {
          const mdRaw = await res.text();
          const { meta, body } = parseAndStripFrontMatter(mdRaw);

          if (!$date.textContent && meta.date) {
            $date.textContent = formatDateByConfig(meta.date);
          }
          // si pas de recap en data.json, prendre celui du front-matter
          if (!(item.recap && item.recap.trim()) && meta.recap) {
            setRecapText(meta.recap);
          }

          links = extractWikiLinks(mdRaw).filter(id => idToItem.has(id));
          const htmlNote = marked.parse(transformWikiLinks(body));
          $md.innerHTML = htmlNote;
        } else {
          $md.innerHTML = `<em style="color:#888;">Note compl√®te indisponible (HTTP ${res.status})</em>`;
        }
      } catch (err) {
        $md.innerHTML = `<em style="color:#888;">Note compl√®te indisponible</em>`;
      }

      if (!links.length) {
        $links.innerHTML = `<div style="color:#888;">Aucun lien sortant</div>`;
      } else {
        $links.innerHTML = `
          <ul style="margin:0; padding-left:18px;">
            ${links.map(lid => {
              const it = idToItem.get(lid);
              const lbl = it?.title || lid;
              const commonTags = Array.isArray(item.tags) && Array.isArray(it?.tags)
                ? item.tags.filter(t => it.tags.includes(t))
                : [];
              const badge = commonTags.length
                ? ` <span style="color:#6b7280;">(${commonTags.join(', ')})</span>`
                : '';
              return `<li><a href="note.html?id=${encodeURIComponent(lid)}" class="internal-link">${lbl}</a>${badge}</li>`;
            }).join('')}
          </ul>
        `;
      }

      $panel.style.display = 'block';

      $panel.querySelectorAll('a[href^="note.html?id="]').forEach(a => {
        a.classList.add('internal-link');
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const href = a.getAttribute('href');
          const id = decodeURIComponent(href.split('id=')[1] || '');
          if (!id) return;
          openSummaryInPanel(id);
          getOutgoingLinks(id).then(lnk => {
            drawLinksFrom(id, lnk);
            window.__lastLinksState = { id, links: lnk };
            const b = new maplibregl.LngLatBounds();
            const from = idToItem.get(id); if (from) b.extend([from.lon, from.lat]);
            lnk.forEach(L => { const t = idToItem.get(L); if (t) b.extend([t.lon, t.lat]); });
            if (!b.isEmpty()) map.fitBounds(b, { padding: 80, duration: 650 });
          });
        });
      });

      if ($fit) {
        $fit.onclick = () => {
          const b = new maplibregl.LngLatBounds();
          const from = idToItem.get(noteId); if (from) b.extend([from.lon, from.lat]);
          links.forEach(lid => { const t = idToItem.get(lid); if (t) b.extend([t.lon, t.lat]); });
          if (!b.isEmpty()) map.fitBounds(b, { padding: 80, duration: 650 });
        };
      }

      drawLinksFrom(noteId, links);
      window.__lastLinksState = { id: noteId, links };
    }

    // === Liens (fetch) ===
    async function getOutgoingLinks(noteId){
      if (linksCache.has(noteId)) return linksCache.get(noteId);
      const url = \`\${NOTE_RAW_BASE}/\${encodeURIComponent(noteId)}.md\`;
      const res = await fetch(url, { cache:'no-store' });
      if (!res.ok) { linksCache.set(noteId, []); return []; }
      const md = await res.text();
      const ids = extractWikiLinks(md).filter(id => idToItem.has(id));
      linksCache.set(noteId, ids);
      return ids;
    }

    // === D√©marrage ===
    function ensureLinksLayer(){ /* placeholder replaced above - function already defined earlier */ }
    // NOTE: ensureLinksLayer is defined above; noop here to avoid duplicate

    map.on('load', () => {
      addMarkersFromJSON().then(applyFilters);
      // liens layer
      // redefine ensureLinksLayer call (real one above)
      // ensureLinksLayer already invoked via other flows when needed
    });
    loadCountries();
    applyUIConfig();
  </script>
</body>
</html>
