<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte interactive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- MapLibre -->
  <link href="https://unpkg.com/maplibre-gl@5.7.3/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@5.7.3/dist/maplibre-gl.js"></script>

  <!-- Turf (optionnel mais utilisé si dispo pour bbox/centroid) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  
  <!-- Marked (pour Markdown des notes) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Overlay pays (géométries réelles) -->
  <script src="countries-overlay.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map {
      width:100%; height:100%;
      background: radial-gradient(circle at 50% 45%, #cfe4ff 0%, #e9f3ff 60%, #fff 100%);
    }
    #map.dark {
      background: radial-gradient(circle at 50% 45%, #0a0f1f 0%, #0d1b2a 60%, #000 100%);
    }

    .btn{display:inline-block;margin-top:6px;padding:8px 10px;background:#1e90ff;color:#fff;border:none;border-radius:8px;font-size:13px;cursor:pointer;width:100%;text-align:left;box-shadow:0 2px 8px rgba(30,144,255,.35);}
    .btn:hover{filter:brightness(.95);}
    .maplibregl-popup{max-width:300px;font-family:system-ui,sans-serif;}

    .maplibregl-ctrl.filters-ctrl .filters-btn{
      min-width:60px;height:30px;display:flex;align-items:center;justify-content:center;
      font-size:14px;background:#fff;border:none;cursor:pointer;
    }
    .filters-panel{
      position:absolute;top:115px;right:10px;z-index:10;width:360px;max-height:60vh;overflow:auto;
      background:#fff;border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.18);
      font-family:system-ui,sans-serif;font-size:14px;display:none;
    }

    .panel-toggle{position:absolute;top:10px;left:10px;z-index:11;width:36px;height:36px;border:none;border-radius:10px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.18);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .panel-toggle[aria-expanded="true"]{display:none;}
    .map-panel{position:absolute;top:10px;left:10px;z-index:10;width:260px;background:rgba(255,255,255,.92);backdrop-filter:blur(8px);border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.2);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;font-size:14px;overflow:hidden;transition:transform .22s ease,opacity .22s ease;}
    .panel-hidden{transform:translateX(-8px);opacity:0;pointer-events:none;}
    .panel-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #e5e7eb;}
    .panel-title{font-weight:700;font-size:15px;}
    .panel-close{border:none;background:#dc2626;color:#fff;border-radius:8px;padding:4px 8px;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.15);}
    .panel-close:hover{filter:brightness(.95);}
    #mapPanelToggle,.maplibregl-ctrl.filters-ctrl .filters-btn,.maplibregl-ctrl-zoom-in,.maplibregl-ctrl-zoom-out{border:1px solid #000;}
    .panel-group{padding:10px 12px 0;}
    .panel-subtitle{font-size:11px;letter-spacing:.04em;text-transform:uppercase;color:#6b7280;margin-bottom:6px;font-weight:600;}
    .radio-row{display:flex;gap:8px;flex-wrap:wrap;}
    .radio-pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;padding:6px 10px;cursor:pointer;user-select:none;transition:all .15s ease;}
    .radio-pill:hover{border-color:#cbd5e1;}
    .radio-pill input{appearance:none;width:0;height:0;position:absolute;}
    .radio-pill input:checked + span{color:#fff;}
    .radio-pill:has(input:checked){background:#1e90ff;border-color:#1e90ff;box-shadow:0 2px 10px rgba(30,144,255,.35) inset,0 0 0 1px rgba(255,255,255,.2);}
    .panel-actions{padding:12px;display:grid;gap:8px;}

    .internal-link{ text-decoration:none; border-bottom:1px dashed #1e90ff;}
    .internal-link:hover{text-decoration:underline;}

    :root{--recap-lines:2;}
    #npRecap.clamped{-webkit-box-orient:vertical;-webkit-line-clamp:var(--recap-lines);display:-webkit-box;overflow:hidden;}
    #npRecapToggle{cursor:pointer;display:inline-block;margin-top:4px;text-decoration:underline;font-style:italic;user-select:none;font-size:.85em;}

    .maplibregl-marker,.internal-link,#npFit,.maplibregl-ctrl button,.filters-ctrl .filters-btn{cursor:pointer;}
    .maplibregl-ctrl-group>button,.filters-ctrl .filters-btn{border:1px solid #000!important;}
    .maplibregl-ctrl-group>button:hover,.filters-ctrl .filters-btn:hover{filter:brightness(.95);}

    .marker--active{background:#0d8f06!important;transform:scale(1.12);box-shadow:0 0 0 2px #fff,0 2px 10px rgba(0,0,0,.35);}
    #npRotateBtn{display:none;font-size:18px;}
    #npRotateBtn:hover{transform:scale(1.06);}
    #npRotateBtn.is-on{background:#facc15;color:#000;}
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Panneau de lecture -->
  <div id="notePanel" style="position:absolute;right:10px;top:10px;width:400px;max-height:88vh;overflow:auto;background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.18);padding:0;display:none;z-index:12;font-family:system-ui;">
    <div id="npHeader" style="background:#facc15;padding:10px 12px;border-radius:12px 12px 0 0;border-bottom:1px solid #0f172a22; position:sticky; top:0; z-index:20;box-shadow:0 4px 8px rgba(0,0,0,.35);">
      <button id="npClose" type="button" aria-label="Fermer" style="position:absolute;top:8px;right:10px;width:26px;height:26px;display:flex;align-items:center;justify-content:center;border:none;border-radius:6px;background:#dc2626;color:#fff;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.15);">✖</button>
      <div id="npTitle" style="font-size:16px;font-weight:700;">Titre</div>
      <div id="npMeta"  style="font-size:12px;opacity:.9;display:flex;align-items:center;gap:6px;margin-top:4px;"><span id="npIcon" style="font-size:14px;line-height:1">📍</span><span id="npPlace">Pays, ville</span></div>
      <div id="npDate"  style="font-size:12px;opacity:.8;display:flex;align-items:center;gap:6px;margin-top:2px;"><span id="npDateIcon" style="font-size:14px;line-height:1">🕓</span><span id="npDateText"></span></div>
      <div id="npEntities" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;"></div>
      <div id="npRecap" style="margin-top:6px;font-weight:600;font-style:italic;"></div>
      <a id="npRecapToggle" href="#" style="display:none;"></a>
    </div>

    <div id="npWrapper" style="padding:6px 6px;">
      <div id="npCard" style="border:1px solid #0f172a22;border-radius:10px;padding:10px;background:#fef9c3;">
        <div id="npSummary" style="font-size:14px;line-height:1.55;margin-bottom:8px;"></div>
        <div id="npMd" style="font-size:14px;line-height:1.55;"></div>
      </div>
      <div id="npLinksWrap" style="margin-top:10px;">
        <div style="font-weight:700;margin:8px 0 6px;">Liens sortants</div>
        <div id="npLinks" style="font-size:14px;"></div>
        <div style="margin-top:8px;display:flex;gap:8px;">
          <button id="npFit"  type="button" style="padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px;background:#fff;cursor:pointer;">🔎 Voir les liés</button>
          <button id="btnClearEntityFocus" type="button" style="margin-left:8px;padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px;background:#fff;cursor:pointer;">Afficher tout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Panneau "Map views" -->
  <button id="mapPanelToggle" class="panel-toggle" aria-expanded="false" aria-controls="mapPanel" title="Afficher/masquer les options carte">🗺️</button>
  <aside id="mapPanel" class="map-panel panel-hidden" aria-label="Options de carte">
    <header class="panel-header">
      <span class="panel-title">Map views</span>
      <button id="mapPanelClose" class="panel-close" aria-label="Masquer le panneau">✕</button>
    </header>
    <section class="panel-group">
      <div class="panel-subtitle">Projection</div>
      <div class="radio-row">
        <label class="radio-pill"><input type="radio" name="projection" value="mercator"><span>2D</span></label>
        <label class="radio-pill"><input type="radio" name="projection" value="globe" checked><span>3D</span></label>
      </div>
    </section>
    <section class="panel-group">
      <div class="panel-subtitle">Style</div>
      <div class="radio-row">
        <label class="radio-pill"><input type="radio" name="basemap" value="streets" checked><span>Streets</span></label>
        <label class="radio-pill"><input type="radio" name="basemap" value="light"><span>Light</span></label>
        <label class="radio-pill"><input type="radio" name="basemap" value="dark"><span>Dark</span></label>
      </div>
    </section>
    <section class="panel-actions">
      <button id="recenterEurope" class="btn" type="button">Recentrer Europe</button>
      <button id="recenterWorld"  class="btn" type="button">Recentrer Monde</button>
    </section>
  </aside>

  <!-- Panneau Filtres -->
  <div id="filtersPanel" class="filters-panel s-panel">
    <h3>Filtres</h3>
    <div class="row"><label>Recherche</label><input type="text" id="filterQuery" placeholder="Titre, lieu, résumé…" /></div>
    <div class="row"><label>Tags</label><div id="tagsBox" class="tags"></div></div>
    <div class="row">
      <label>Pays</label>
      <select id="filterCountry" multiple size="6" style="width:100%;border:1px solid #ddd;border-radius:8px;padding:6px;"></select>
      <div style="display:flex;gap:8px;margin-top:6px;">
        <button id="selectAllCountries" class="filters-reset" type="button" style="flex:1;">Tout sélectionner</button>
        <button id="clearAllCountries"  class="filters-reset" type="button" style="flex:1;">Tout désélectionner</button>
      </div>
    </div>
    <div class="row">
      <div class="filters-actions">
        <button class="filters-apply" id="applyFilters"   type="button">Appliquer</button>
        <button class="filters-reset" id="resetFilters"   type="button">Réinitialiser</button>
      </div>
    </div>
  </div>

  <script>
  // ========= CONFIG =========
  const MAPTILER_KEY = "MLrpRZ0Wo2Dsvsj13UYN";

  const UI_CONFIG = {
    panel:{ width:"400px", marginRight:"10px", marginTop:"10px", background:"#fff", shadow:"0 8px 24px rgba(0,0,0,.18)", borderRadius:"12px"},
    header:{ background:"#facc15", textColor:"#000", titleSize:"16px", locationIcon:"📍", dateIcon:"🕓", metaIndent:"0px", dateIndent:"0px",
      dateFormat:{ day:"numeric", month:"long", year:"numeric" },
      recapFontSize:"12px", recapStyle:"font-weight:600; font-style:italic;", recapMaxLines:2, recapMoreLabel:" […]", recapLessLabel:" ↥ réduire"
    },
    card:{ background:"#fef9c3", border:"1px solid #0f172a22", borderRadius:"10px", outerPadding:"8px 10px", innerPadding:"10px", fontSize:"14px", lineHeight:"1.55" },
    links:{ sectionTitle:"Liens sortants", internalLinkColor:"#1e90ff", internalLinkUnderline:"dashed",
      lineColor:"#9e0909", lineWidth:2.5, lineOpacity:0.95, lineDasharray:null, casingColor:"#470303", casingWidth:0,
      curveStyle:"bezier", curveStrength:0.3, curveSteps:96
    }
  };

  // pays actuellement mis en avant (pour le restaurer après style.load)
  let CURRENT_FOCUSED_COUNTRY = null;
  
  function bringCountryOverlayToFront(){
    try { if (map.getLayer('country-overlay-outline')) map.moveLayer('country-overlay-outline'); } catch {}
    try { if (map.getLayer('country-overlay-fill'))    map.moveLayer('country-overlay-fill');    } catch {}
  }

  function setUIStyle(css){ let tag=document.getElementById('ui-overrides'); if(!tag){tag=document.createElement('style');tag.id='ui-overrides';document.head.appendChild(tag);} tag.textContent=css; }
  function applyUIConfig(){
    const P=UI_CONFIG.panel,H=UI_CONFIG.header,C=UI_CONFIG.card,L=UI_CONFIG.links;
    setUIStyle(`#notePanel{width:${P.width};right:${P.marginRight};top:${P.marginTop};background:${P.background};box-shadow:${P.shadow};border-radius:${P.borderRadius}}
      #npHeader{background:${H.background};color:${H.textColor}} #npTitle{font-size:${H.titleSize}}
      #npMeta{margin-left:${H.metaIndent}} #npDate{margin-left:${H.metaIndent}}
      #npRecap{${H.recapStyle};font-size:${H.recapFontSize||"13px"};width:100%;text-align:justify}
      #npWrapper{padding:${C.outerPadding}} #npCard{background:${C.background};border:${C.border};border-radius:${C.borderRadius};padding:${C.innerPadding};font-size:${C.fontSize};line-height:${C.lineHeight}}
      .internal-link{border-bottom:1px ${L.internalLinkUnderline} ${L.internalLinkColor};color:inherit}`);
    const icon=document.getElementById('npIcon'); if(icon) icon.textContent=H.locationIcon;
    const dateIcon=document.getElementById('npDateIcon'); if(dateIcon) dateIcon.textContent=H.dateIcon||'🕓';
    document.documentElement.style.setProperty('--recap-lines', String((UI_CONFIG.header && UI_CONFIG.header.recapMaxLines) || 2));
  }

  // ========= LIBS UTIL =========
  function renderWikiLinksInline(text){
    if(!text) return '';
    return text.replace(/\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/g,(m,rawId,label)=>{const id=String(rawId).trim();const txt=(label||id).trim();return `<a href="note.html?id=${encodeURIComponent(id)}" target="_blank" rel="noopener" class="internal-link">${txt}</a>`;});
  }
  function transformWikiLinks(md){ return md.replace(/\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/g,(m,rawId,label)=>{const id=String(rawId||'').trim(); if(!id) return m; const txt=String(label||id).trim(); return `[${txt}](note.html?id=${encodeURIComponent(id)})`;}); }
  function parseAndStripFrontMatter(text){
    let meta={}; if(text.startsWith('---')){const end=text.indexOf('\n---',3); if(end!==-1){const fm=text.slice(3,end).trim(); text=text.slice(end+4).trimStart();
      fm.split('\n').forEach(line=>{const idx=line.indexOf(':'); if(idx>-1){const key=line.slice(0,idx).trim(); let raw=line.slice(idx+1).trim();
        const unq=v=>((v.startsWith('"')&&v.endsWith('"'))||(v.startsWith("'")&&v.endsWith("'")))?v.slice(1,-1):v;
        if(raw.startsWith('[')&&raw.endsWith(']')){const inside=raw.slice(1,-1).trim(); meta[key]=inside?inside.split(',').map(s=>unq(s.trim())).filter(Boolean):[];}
        else{ if(/^(true|false)$/i.test(raw)) meta[key]=/^true$/i.test(raw); else if(/^-?\d+(\.\d+)?$/.test(raw)) meta[key]=Number(raw); else meta[key]=unq(raw); }
      }})}}
    return {meta,body:text};
  }

  // ========= DONNÉES =========
  let allData=[]; let allTags=new Set(); const idToItem=new Map(); const linksCache=new Map(); window.__lastLinksState=null;

  async function loadDataFromJSON(){
    if(allData.length===0){ try{ const res=await fetch('data.json',{cache:'no-store'}); allData=await res.json(); }catch(e){ console.error('Erreur chargement data.json',e); return; } }
    idToItem.clear(); allData.forEach(it=>{ if(it&&it.id) idToItem.set(it.id,it); });
    allTags.clear(); allData.forEach(item=>{ if(Array.isArray(item.tags)){ item.tags.forEach(t=>{ if(t&&String(t).trim()) allTags.add(String(t).trim());});}});
    buildTagCheckboxes();
  }
  function buildTagCheckboxes(){
    const box=document.getElementById('tagsBox'); if(!box) return; box.innerHTML='';
    if(allTags.size===0){ box.innerHTML='<div style="color:#777;font-size:13px;">Aucun tag détecté</div>'; return; }
    Array.from(allTags).sort((a,b)=>a.localeCompare(b)).forEach(tag=>{const label=document.createElement('label'); label.className='tag'; const cb=document.createElement('input'); cb.type='checkbox'; cb.name='tag'; cb.value=tag; const txt=document.createElement('span'); txt.textContent=tag; label.appendChild(cb); label.appendChild(txt); box.appendChild(label);});
  }

  // ========= STYLE & CARTE =========
  const STYLES={
    streets:`https://api.maptiler.com/maps/streets/style.json?key=${MAPTILER_KEY}`,
    light:  `https://api.maptiler.com/maps/basic/style.json?key=${MAPTILER_KEY}`,
    dark:   `https://api.maptiler.com/maps/dataviz-dark/style.json?key=${MAPTILER_KEY}`
  };
  let CURRENT_BASEMAP='streets', CURRENT_PROJECTION='globe';
  function getStyleURL(b){ return STYLES[b]||STYLES.streets; }

  const DEFAULT_ZOOM=3.8, EUROPE_CENTER=[10,50], WORLD_CENTER=[0,20], WORLD_ZOOM=2.2;
  const ARRIVAL_ZOOM=WORLD_ZOOM+0.45;

  const map=new maplibregl.Map({ container:'map', style:getStyleURL(CURRENT_BASEMAP), center:WORLD_CENTER, zoom:WORLD_ZOOM, projection:'globe', renderWorldCopies:false });

  // ========= ROTATION GLOBE =========
  let __npRotateOn=false, __npRotateRAF=null, __npUserInteracting=false; const __npTEST_SPEED_DEG_PER_SEC=7;
  function getRotateBtn(){return document.getElementById('npRotateBtn');}
  function __npUpdateRotateBtn(){const b=getRotateBtn(); if(!b) return; if(__npRotateOn){b.classList.add('is-on'); b.title='Arrêter la rotation'; b.setAttribute('aria-label','Arrêter la rotation du globe');}else{b.classList.remove('is-on'); b.title='Rotation automatique'; b.setAttribute('aria-label','Activer la rotation du globe');}}
  function __npRotateStep(ts){ if(!__npRotateOn){__npRotateRAF=null;return;} if(!__npUserInteracting && CURRENT_PROJECTION==='globe'){const now=ts||performance.now(); const dt=(now-(__npRotateStep._lastTs||now)); __npRotateStep._lastTs=now; const c=map.getCenter(); let lon=c.lng; lon+=__npTEST_SPEED_DEG_PER_SEC*(dt/1000); if(lon>180) lon-=360; if(lon<-180) lon+=360; map.setCenter([lon,0]); } __npRotateRAF=requestAnimationFrame(__npRotateStep);}
  function npToggleRotation(){__npRotateOn=!__npRotateOn; if(__npRotateOn){__npRotateStep._lastTs=undefined; if(!__npRotateRAF) __npRotateRAF=requestAnimationFrame(__npRotateStep);} else{if(__npRotateRAF) cancelAnimationFrame(__npRotateRAF); __npRotateRAF=null;} __npUpdateRotateBtn();}
  ['dragstart','rotatestart','pitchstart','zoomstart'].forEach(ev=>map.on(ev,()=>{__npUserInteracting=true;}));
  ['dragend','rotateend','pitchend','zoomend'].forEach(ev=>map.on(ev,()=>{__npUserInteracting=false; if(__npRotateOn && CURRENT_PROJECTION==='globe'){const c=map.getCenter(); map.easeTo({center:[c.lng,0],duration:300});}}));
  function updateRotateButtonVisibility(){const b=getRotateBtn(); if(!b) return; if(CURRENT_PROJECTION==='globe'){b.style.display='flex';}else{b.style.display='none'; __npRotateOn=false; if(__npRotateRAF) cancelAnimationFrame(__npRotateRAF); __npRotateRAF=null; __npUpdateRotateBtn();}}

  // ========= PROJECTION / TERRAIN / SOLEIL =========
  let __sunTimer=null;
  function updateSun(){const now=new Date(); const t=(now.getHours()+now.getMinutes()/60)/24; const az=t*360; const alt=Math.sin(t*2*Math.PI)*35+25; try{ if(map.getLayer('sky')) map.setPaintProperty('sky','sky-atmosphere-sun',[az,alt]); }catch{} }
  function startSun(){updateSun(); clearInterval(__sunTimer); __sunTimer=setInterval(updateSun,30000);}
  function applyProjection(){const type=(CURRENT_PROJECTION==='globe')?'globe':'mercator'; try{map.setProjection({type});}catch(e){console.warn('Projection non supportée',e);} if(type==='globe'){ if(typeof map.setFog==='function'){try{map.setFog({range:[0.5,10],color:'rgba(160,190,220,0.9)','horizon-blend':0.25});}catch(e){}} startSun?.(); } else { if(typeof map.setFog==='function'){try{map.setFog(null);}catch{}} if(__sunTimer){clearInterval(__sunTimer); __sunTimer=null;} }}
  function ensureTerrain(){ if(CURRENT_PROJECTION==='globe'){try{map.setTerrain(null);}catch{} try{if(map.getLayer('terrain-hillshade')) map.removeLayer('terrain-hillshade');}catch{} try{if(map.getSource('terrain-dem-hs')) map.removeSource('terrain-dem-hs');}catch{} try{if(map.getSource('terrain-dem')) map.removeSource('terrain-dem');}catch{} return;}
    if(!map.getSource('terrain-dem')) map.addSource('terrain-dem',{type:'raster-dem',url:`https://api.maptiler.com/tiles/terrain-rgb-v2/tiles.json?key=${MAPTILER_KEY}`,tileSize:512,maxzoom:14});
    try{ map.setTerrain({source:'terrain-dem',exaggeration:1.4});
      if(!map.getSource('terrain-dem-hs')) map.addSource('terrain-dem-hs',{type:'raster-dem',url:`https://api.maptiler.com/tiles/terrain-rgb-v2/tiles.json?key=${MAPTILER_KEY}`,tileSize:512,maxzoom:14});
      if(!map.getLayer('terrain-hillshade')) map.addLayer({id:'terrain-hillshade',type:'hillshade',source:'terrain-dem-hs',paint:{'hillshade-exaggeration':0.6,'hillshade-shadow-color':'#000','hillshade-highlight-color':'#fff'}});
    }catch(e){console.warn('Terrain:',e);} }

  // ========= NOTES / RÉSEAU =========
  const NOTE_RAW_BASE='https://raw.githubusercontent.com/antoninbld/geo_map_notes/main/docs/notes';
  const EVENTS_BASE=NOTE_RAW_BASE; const ENTITIES_BASE=`${NOTE_RAW_BASE}/entities`;
  function resolveNoteURL(noteId){
    if(!String(noteId).startsWith('ent-')) return `${EVENTS_BASE}/${encodeURIComponent(noteId)}.md`;
    let sub=''; if(noteId.startsWith('ent-country-')) sub='countries'; else if(noteId.startsWith('ent-org-')) sub='orgs'; else if(noteId.startsWith('ent-person-')) sub='person';
    return `${ENTITIES_BASE}/${sub}/${encodeURIComponent(noteId)}.md`;
  }

  /* ---- Custom layer Three.js pour arcs 3D (missiles) ---- */
  const MissileArcsLayer = (function(){
    let camera, scene, renderer, mapRef;
    const group = new THREE.Group();
    const meshes = [];
  
    function lngLatAltToWorld([lng, lat, altM = 0]){
      const mc = maplibregl.MercatorCoordinate.fromLngLat({lng, lat}, altM);
      return new THREE.Vector3(mc.x, mc.y, mc.z || 0);
    }
  
    function makeArc3D(
      aLngLat, 
      bLngLat, 
      { heightFactor = 0.18, lateralFactor = 0.22, segments = 120, radius = 2200, color = 0xdb6402 } = {}
    ){
      // Points monde aux extrémités (alt ≈ 0 m)
      const A = lngLatAltToWorld([aLngLat[0], aLngLat[1], 0]);
      const B = lngLatAltToWorld([bLngLat[0], bLngLat[1], 0]);
    
      // Géométrie utile
      const dir   = new THREE.Vector3().subVectors(B, A);        // direction AB en 3D
      const len   = dir.length() || 1;
      const mid   = new THREE.Vector3().addVectors(A, B).multiplyScalar(0.5);
      const up    = new THREE.Vector3(0, 0, 1);                  // axe vertical
    
      // Perpendiculaire **dans le plan XY** (pour la courbure visible vue de dessus)
      const dirXY = new THREE.Vector3(dir.x, dir.y, 0);
      const perpXY = (dirXY.length() > 0)
        ? new THREE.Vector3(-dirXY.y, dirXY.x, 0).normalize()
        : new THREE.Vector3(1, 0, 0); // fallback
    
      // Amplitudes
      const h = len * heightFactor;    // élévation (z)
      const s = len * lateralFactor;   // déport latéral (xy)
    
      // 4 points de contrôle pour une courbe bien "balistique"
      // P1 et P2 décalés latéralement + partiellement en hauteur
      const P1 = new THREE.Vector3().addVectors(
        new THREE.Vector3().addVectors(A, mid).multiplyScalar(0.5),
        new THREE.Vector3().addScaledVector(perpXY, 0.5 * s).addScaledVector(up, 0.5 * h)
      );
      const APEX = new THREE.Vector3().addVectors(
        mid,
        new THREE.Vector3().addScaledVector(perpXY, s).addScaledVector(up, h)
      );
      const P2 = new THREE.Vector3().addVectors(
        new THREE.Vector3().addVectors(mid, B).multiplyScalar(0.5),
        new THREE.Vector3().addScaledVector(perpXY, 0.5 * s).addScaledVector(up, 0.5 * h)
      );
    
      // Courbe CatmullRom (A -> P1 -> APEX -> P2 -> B)
      const curve = new THREE.CatmullRomCurve3([A, P1, APEX, P2, B]);
      const geom  = new THREE.TubeGeometry(curve, segments, radius, 8, false);
      const mat   = new THREE.MeshBasicMaterial({ color, opacity: 0.95, transparent: true });
      return new THREE.Mesh(geom, mat);
    }
  
    return {
      id: 'entity-focus-arcs-3d',
      type: 'custom',
      renderingMode: '3d',
      onAdd(map, gl){
        mapRef = map;
        camera = new THREE.Camera();
        scene  = new THREE.Scene();
        scene.add(group);
        renderer = new THREE.WebGLRenderer({ canvas: map.getCanvas(), context: gl, antialias: true });
        renderer.autoClear = false;
      },
      render(gl, matrix){
        camera.projectionMatrix = new THREE.Matrix4().fromArray(matrix);
        renderer.state.reset();
        renderer.render(scene, camera);
        mapRef.triggerRepaint();
      },
      clear(){
        for (const m of group.children.slice()) {
          group.remove(m);
          m.geometry?.dispose?.();
          m.material?.dispose?.();
        }
      },
      setArcs(pairs){
        this.clear();
        for(const p of pairs){
          const mesh = makeArc3D(p.from, p.to, {
            heightFactor: p.heightFactor ?? 0.18,
            segments: 96,
            radius: 2200,
            color: (typeof p.color === 'string') ? new THREE.Color(p.color) : (p.color ?? 0xdb6402)
          });
          group.add(mesh);
        }
      }
    };
  })();

  // ========= ENTITÉS =========
  const EVENTS_BY_ENTITY=new Map(); const __scannedEventsForEntities=new Set();
  const ENTITY_NAME_TO_ID=new Map([
    ['anouar al sadate','ent-person-anouar-al-sadate'],['sadate','ent-person-anouar-al-sadate'],
    ['egypte','ent-country-egypte'],['israël','ent-country-israel'],['israel','ent-country-israel'],['usa','ent-country-usa'],['urss','ent-country-urss'],
    ['cia','ent-org-cia'],['kgb','ent-org-kgb']
  ]);
  function normalizeEntityLabelToId(label){
    if(!label) return null;
    if(String(label).startsWith('ent-')) return label;
    const key=String(label).normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
    return ENTITY_NAME_TO_ID.get(key)||null;
  }

  async function ensureEntityIndexFilled(entityId){
    for(const it of allData){
      if(__scannedEventsForEntities.has(it.id)) continue;
      try{
        const url=resolveNoteURL(it.id);
        const res=await fetch(url,{cache:'no-store'});
        if(res.ok){
          const md=await res.text();
          const {meta}=parseAndStripFrontMatter(md);
          let ents=Array.isArray(meta.entities)?meta.entities:[];
          ents=ents.map(e=>normalizeEntityLabelToId(e)).filter(Boolean);
          ents.forEach(entId=>{
            if(!EVENTS_BY_ENTITY.has(entId)) EVENTS_BY_ENTITY.set(entId,new Set());
            EVENTS_BY_ENTITY.get(entId).add(it.id);
          });
        }
      }catch{}
      __scannedEventsForEntities.add(it.id);
    }
    return new Set(EVENTS_BY_ENTITY.get(entityId)||[]);
  }

  function setEntityFocusVisibility(visible){
    const vis=visible?'visible':'none';
    try{map.setLayoutProperty('entity-focus-links','visibility',vis);}catch{}
    try{map.setLayoutProperty('entity-focus-point','visibility',vis);}catch{}
  }

  function undimAll(){ try{ allData.forEach(it=>{ if(it&&it.id!=null) map.setFeatureState({source:'notes',id:it.id},{dim:false});}); }catch{} }

  // ——— clear focus ENTITÉ (utilise CountryOverlay.hide) ———
  function clearEntityFocus(){
    setEntityFocusVisibility(false);
    try { map.getSource('entity-focus')?.setData({ type:'FeatureCollection', features: [] }); } catch {}
    try { allData.forEach(it => { if (it && it.id != null) map.setFeatureState({ source:'notes', id: it.id }, { dim: false }); }); } catch {}
    try { map.getSource('entity-focus-links')?.setData({ type:'FeatureCollection', features: [] }); } catch {}
    try { undimAll(); } catch {}

    try {
      if (map.getLayer('entity-focus-arcs-3d') && typeof MissileArcsLayer.clear === 'function') {
        MissileArcsLayer.clear();
      }
    } catch {}
  
    // masque l’overlay pays si présent
    try { window.CountryOverlay?.hide(map); } catch {}
    CURRENT_FOCUSED_COUNTRY = null;
  }
  document.getElementById('btnClearEntityFocus')?.addEventListener('click', clearEntityFocus);

  // ——— Affiche la constellation & overlay pays via CountryOverlay.show ———
  async function showEntityConstellation(entId){
    // 1) Construire l’ensemble des éléments liés
    const linked = await ensureEntityIndexFilled(entId);
    if(!linked || !linked.size){
      CURRENT_FOCUSED_COUNTRY = null;
      clearEntityFocus();
      return;
    }
  
    // petit helper padding droit (panneau latéral)
    function computeRightPad(){
      const pw = parseInt((UI_CONFIG?.panel?.width ?? 400), 10);
      const pr = parseInt((UI_CONFIG?.panel?.marginRight ?? 10), 10);
      const w  = map.getContainer().clientWidth || 800;
      let rightPad = Math.round(pw * 1.25) + pr + 10;
      return Math.min(rightPad, Math.max(0, w - 120)); // clamp pour éviter l’erreur "cannot fit"
    }
  
    let origin = null;
    let overlayDidFrame = false; // vrai si l’overlay a déjà cadré la vue
  
    // 2) Si c’est un pays : afficher overlay + focus (centre override si dispo, sinon fitBounds pays)
    if (entId.startsWith('ent-country-') && window.CountryOverlay){
      CURRENT_FOCUSED_COUNTRY = entId;
  
      // centre/zoom automatique (override -> easeTo, sinon fitBounds pays)
      try{
        await CountryOverlay.focus(map, entId, {
          zoom: 3,
          duration: 200,
          rightPanelPx: parseInt((UI_CONFIG?.panel?.width ?? 400), 10),
          marginRight: parseInt((UI_CONFIG?.panel?.marginRight ?? 10), 10)
        });
        overlayDidFrame = true;
      }catch{}
  
      // s’assurer que l’overlay passe au-dessus
      try { CountryOverlay.bringToFront(); } catch {}
  
      // récupérer un centre pertinent (override > centerOfMass > fallback)
      try{
        const originInfo = await CountryOverlay.getOriginForCountry(map, entId);
        if (originInfo?.origin) origin = originInfo.origin;
      }catch{}
    } else {
      // si on clique autre chose qu'un pays, on désactive l'overlay courant
      CURRENT_FOCUSED_COUNTRY = null;
      try { if (window.CountryOverlay) CountryOverlay.hide(map); } catch {}
    }
  
    // 3) Si pas d’origin encore (pas un pays ou pays sans centre), moyenne des notes liées
    if(!origin){
      const pts = Array.from(linked).map(id=>idToItem.get(id)).filter(Boolean);
      if(pts.length){
        const sx = pts.reduce((a,p)=>a+p.lon,0), sy = pts.reduce((a,p)=>a+p.lat,0);
        origin = [sx/pts.length, sy/pts.length];
      } else {
        origin = map.getCenter().toArray();
      }
    }
  
    // 4) Construire la constellation (lignes depuis origin -> chaque note liée)
    const features=[]; 
    const bounds=new maplibregl.LngLatBounds().extend(origin);
    for(const eid of linked){
      const it=idToItem.get(eid); if(!it) continue;
      features.push({
        type:'Feature',
        geometry:{type:'LineString',coordinates:[origin,[it.lon,it.lat]]},
        properties:{kind:'edge',entityId:entId,to:eid}
      });
      bounds.extend([it.lon,it.lat]);
    }
  
    // 5) Pousser la constellation dans la source + rendre visible
    try{
      const src = map.getSource('entity-focus');
      if(src && src.setData) src.setData({ type:'FeatureCollection', features });
      setEntityFocusVisibility(true); // doit rendre visibles 'entity-focus-links' et 'entity-focus-point'
    }catch{}

    // --- Arcs 3D au-dessus des traits 2D ---
    try {
      if (map.getLayer('entity-focus-arcs-3d') && typeof MissileArcsLayer.setArcs === 'function') {
        const pairs = [];
        for (const eid of linked) {
          const it = idToItem.get(eid); if(!it) continue;
          pairs.push({
            from: origin,
            to: [it.lon, it.lat],
            color: '#db6402',   // même teinte que l’overlay pays
            heightFactor: 0.18  // bosse de l’arc (augmente pour + “missile”)
          });
        }
        MissileArcsLayer.setArcs(pairs);
      }
    } catch {}
  
    // 6) Dim toutes les notes sauf celles liées
    try{
      allData.forEach(it=>{ if(it && it.id!=null) map.setFeatureState({source:'notes',id:it.id},{dim:true}); });
      Array.from(linked).forEach(id=>{ map.setFeatureState({source:'notes',id},{dim:false}); });
    }catch{}
  
    // 7) Si l’overlay n’a pas cadré la vue (cas non-pays ou pays sans fit), fit sur la constellation
    if(!overlayDidFrame && !bounds.isEmpty()){
      try{
        map.fitBounds(bounds, { padding:{ top:40, left:40, bottom:40, right: computeRightPad() }, duration:650 });
      }catch{
        // fallback: centre simple
        map.easeTo({ center: origin, zoom: Math.max(map.getZoom(), 4.2), duration: 600 });
      }
    }
  }

  // ========= RÉCAP + NOTE PANEL =========
  function updateRecapToggleLabel(collapsed){
    const t=document.getElementById('npRecapToggle'); if(!t) return;
    const H=UI_CONFIG.header||{};
    t.textContent = collapsed ? (H.recapMoreLabel||' […]') : (H.recapLessLabel||' ↥ réduire');
  }
  function setupRecapToggle(){
    const wrap=document.getElementById('npRecap'); const t=document.getElementById('npRecapToggle'); if(!wrap||!t) return;
    const has=!!wrap.textContent.trim(); t.style.display=has?'inline-block':'none'; if(!has) return;
    wrap.classList.add('clamped'); updateRecapToggleLabel(true);
    t.onclick=(e)=>{e.preventDefault(); const collapsed=wrap.classList.toggle('clamped'); updateRecapToggleLabel(collapsed);};
  }
  function setRecapText(text){ const wrap=document.getElementById('npRecap'); if(!wrap) return; wrap.innerHTML=text?renderWikiLinksInline(text):''; setupRecapToggle(); }

  function renderEntityChips(list){
    const box=document.getElementById('npEntities'); if(!box) return; box.innerHTML='';
    (list||[]).forEach(id=>{
      const a=document.createElement('a'); a.href='#'; a.dataset.entityChip=id;
      a.textContent=id.replace(/^ent-(country|org|person)-/,'');
      a.style.cssText='padding:2px 6px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-size:12px;cursor:pointer;';
      a.addEventListener('click',async(e)=>{e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation(); await showEntityConstellation(id);});
      box.appendChild(a);
    });
  }

  function parseDateSmart(s){ if(!s) return null; const str=String(s).trim();
    let m=str.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m) return new Date(+m[1],+m[2]-1,+m[3]);
    m=str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(m) return new Date(+m[3],+m[2]-1,+m[1]);
    m=str.match(/^(\d{2})-(\d{2})-(\d{4})$/); if(m) return new Date(+m[3],+m[2]-1,+m[1]);
    return null;
  }
  function formatDateByConfig(s){ const d=parseDateSmart(s); if(!d) return s||''; return new Intl.DateTimeFormat('fr-FR',UI_CONFIG.header.dateFormat).format(d); }

  function extractWikiLinks(mdText){ const found=new Set(); const re=/\[\[([^\]\|]+)(?:\|[^\]]+)?\]\]/g; let m; while((m=re.exec(mdText))!==null){const id=m[1].trim(); if(id) found.add(id);} return Array.from(found); }
  async function getOutgoingLinks(noteId){
    if(linksCache.has(noteId)) return linksCache.get(noteId);
    const url=`${NOTE_RAW_BASE}/${encodeURIComponent(noteId)}.md`;
    const res=await fetch(url,{cache:'no-store'}); if(!res.ok){linksCache.set(noteId,[]); return [];}
    const md=await res.text(); const ids=extractWikiLinks(md).filter(id=>idToItem.has(id));
    linksCache.set(noteId,ids); return ids;
  }

  // ========= COUCHE LIENS =========
  function ensureLinksLayer(){
    if(!map.isStyleLoaded?.() && !map.loaded?.()){ map.once('load',ensureLinksLayer); map.once('style.load',ensureLinksLayer); return; }
    if(!map.getSource('note-links')) map.addSource('note-links',{type:'geojson',data:{type:'FeatureCollection',features:[]}});

    const L=UI_CONFIG.links||{};
    if(!map.getLayer('note-links-line')){
      map.addLayer({id:'note-links-line',type:'line',source:'note-links',layout:{'line-cap':'round','line-join':'round'},
        paint:{'line-color':L.lineColor||'#ff0088','line-width':L.lineWidth||3.5,'line-opacity':L.lineOpacity??0.95, ...(L.lineDasharray?{'line-dasharray':L.lineDasharray}:{})}});
    }else{
      map.setPaintProperty('note-links-line','line-color',L.lineColor||'#ff0088');
      map.setPaintProperty('note-links-line','line-width',L.lineWidth||3.5);
      map.setPaintProperty('note-links-line','line-opacity',L.lineOpacity??0.95);
      if(L.lineDasharray){ map.setPaintProperty('note-links-line','line-dasharray',L.lineDasharray); } else { try{map.setPaintProperty('note-links-line','line-dasharray',null);}catch{} }
    }
    try{ map.moveLayer('note-links-line'); }catch{}
  }
  function bezierCurveCoords(from,to,strength=0.25,steps=64){
    const p0=[from.lon,from.lat], p2=[to.lon,to.lat]; const mx=(p0[0]+p2[0])/2, my=(p0[1]+p2[1])/2; const vx=p2[0]-p0[0], vy=p2[1]-p0[1];
    const nx=-vy, ny=vx; const len=Math.sqrt(nx*nx+ny*ny)||1; const ux=nx/len, uy=ny/len; const amp=strength*Math.hypot(vx,vy); const cx=mx+ux*amp, cy=my+uy*amp;
    const coords=[]; for(let i=0;i<=steps;i++){const t=i/steps, it=1-t; const x=it*it*p0[0]+2*it*t*cx+t*t*p2[0]; const y=it*it*p0[1]+2*it*t*cy+t*t*p2[1]; coords.push([x,y]);} return coords;
  }
  function geodesicCoords(from,to,steps=64){ if(!(window.turf&&turf.greatCircle)) return [[from.lon,from.lat],[to.lon,to.lat]]; const fc=turf.greatCircle([from.lon,from.lat],[to.lon,to.lat],{npoints:Math.max(2,steps),properties:{}}); return fc.geometry.coordinates; }
  function curveBetween(from,to){ const L=UI_CONFIG.links||{}; const style=L.curveStyle||'bezier', steps=L.curveSteps||64; if(style==='geodesic') return geodesicCoords(from,to,steps); const s=L.curveStrength??0.25; return bezierCurveCoords(from,to,s,steps); }
  function drawLinksFrom(noteId,linkedIds){
    ensureLinksLayer(); const src=map.getSource('note-links'); if(!src) return; const from=idToItem.get(noteId);
    if(!from){ src.setData({type:'FeatureCollection',features:[]}); return;}
    const features=(linkedIds||[]).map(id=>{const to=idToItem.get(id); if(!to) return null; return {type:'Feature',geometry:{type:'LineString',coordinates:curveBetween(from,to)},properties:{from:noteId,to:id}};}).filter(Boolean);
    src.setData({type:'FeatureCollection',features}); try{ if(map.getLayer('note-links-line')) map.moveLayer('note-links-line'); }catch{}
  }
  function clearLinks(){ const src=map.getSource('note-links'); if(src) src.setData({type:'FeatureCollection',features:[]}); }

  // ========= INTERACTIONS =========
  let __selectedId=null;
  function onClickUnclustered(e){
    const f=e.features && e.features[0]; if(!f||!f.properties||f.properties.id==null) return; const id=f.properties.id; const coords=f.geometry&&f.geometry.coordinates;
    if(__selectedId!=null){ try{map.setFeatureState({source:'notes',id:__selectedId},{selected:false});}catch{} }
    try{map.setFeatureState({source:'notes',id},{selected:true});}catch{} __selectedId=id;
    openSummaryInPanel(id);
    try{
      const pw=parseInt((UI_CONFIG.panel&&UI_CONFIG.panel.width)||'400',10);
      const pr=parseInt((UI_CONFIG.panel&&UI_CONFIG.panel.marginRight)||'10',10);
      const rightPad=pw+pr+10;
      if(coords&&Array.isArray(coords)){
        map.easeTo({center:coords, zoom:ARRIVAL_ZOOM, padding:{top:20,left:20,bottom:20,right:rightPad}, duration:600});
      }
    }catch{}
  }
  function onClickAnyCluster(e){
    const f=e && e.features && e.features[0]; if(!f){return;}
    const props=f.properties||{}; const rawId=(props.cluster_id ?? props.clusterId); const clusterId=typeof rawId==='string'?parseInt(rawId,10):rawId;
    const sourceId=(f.layer&&f.layer.source)?f.layer.source:'notes'; const src=map.getSource(sourceId);
    const center=(f.geometry&&f.geometry.coordinates)||map.getCenter();
    const fallbackZoom=Math.min(map.getZoom()+3,18);
    if(!src||clusterId==null||!Array.isArray(center)){ map.easeTo({center,zoom:fallbackZoom,duration:600}); return; }
    let done=false; const finish=(a)=>{ if(done) return; done=true; if(a==='fallback'){ map.easeTo({center,zoom:fallbackZoom,duration:600}); } };
    const tm=setTimeout(()=>finish('fallback'),200);
    try{
      if(typeof src.getClusterExpansionZoom==='function'){
        src.getClusterExpansionZoom(clusterId,(err,z)=>{ if(done) return; clearTimeout(tm); if(err||typeof z!=='number') return finish('fallback'); const target=Math.min(z+1,18); done=true; map.easeTo({center,zoom:target,duration:600}); });
      }else{ clearTimeout(tm); finish('fallback');}
    }catch(ex){ clearTimeout(tm); finish('fallback');}
  }

  // ========= CHARGEMENT CARTE =========
  map.on('load', async ()=>{
    await CountryOverlay.init(map); 
    await loadDataFromJSON();

    // Source clusterisée
    const features=allData.map(item=>({type:'Feature',geometry:{type:'Point',coordinates:[item.lon,item.lat]},properties:{id:item.id,title:item.title}}));
    map.addSource('notes',{type:'geojson',data:{type:'FeatureCollection',features}, promoteId:'id', cluster:true, clusterMaxZoom:14, clusterRadius:50});
    map.addLayer({id:'clusters',type:'circle',source:'notes',filter:['has','point_count'],paint:{'circle-color':'#ba274f','circle-radius':20}});
    map.addLayer({id:'cluster-count',type:'symbol',source:'notes',filter:['has','point_count'],layout:{'text-field':'{point_count_abbreviated}','text-font':['Open Sans Regular','Noto Sans Regular','Arial Unicode MS Regular'],'text-size':['interpolate',['linear'],['zoom'],0,12,6,14,10,16],'text-anchor':'center','text-offset':[0,0],'text-allow-overlap':true,'text-ignore-placement':true},paint:{'text-color':'#050404','text-halo-color':'#050404','text-halo-width':0.2}});
    try{map.moveLayer('cluster-count');}catch{}
    map.addLayer({id:'unclustered-point',type:'circle',source:'notes',filter:['!', ['has','point_count']],paint:{
      'circle-color':['case',['boolean',['feature-state','selected'],false],'#37cc12','#ff2d2d'],
      'circle-radius':['case',['boolean',['feature-state','selected'],false],10,6],
      'circle-opacity':['case',['boolean',['feature-state','dim'],false],0.25,1],
      'circle-stroke-width':2,'circle-stroke-color':'#7a0000'
    }});

    // Liens
    ensureLinksLayer();

    // Constellation (source/layers)
    if(!map.getSource('entity-focus')){
      map.addSource('entity-focus',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    }
    if(!map.getLayer('entity-focus-links')){
      map.addLayer({
        id:'entity-focus-links',
        type:'line',
        source:'entity-focus',
        filter:['==',['get','kind'],'edge'],
        layout:{ visibility:'none' },
        paint:{ 'line-width':2,'line-color':'#db6402','line-opacity':0.8,'line-dasharray':[1.5,1.5] }
      }, 'clusters');
    }
    // ➊ — AJOUTE CE BLOC :
    if(!map.getLayer('entity-focus-point')){
      map.addLayer({
        id:'entity-focus-point',
        type:'circle',
        source:'entity-focus',
        layout:{ visibility:'none' },
        paint:{ 'circle-radius':6, 'circle-color':'#db6402', 'circle-stroke-width':2, 'circle-stroke-color':'#ffffff' }
      }, 'clusters');
    }

    // Arcs 3D (missiles)
    if (!map.getLayer('entity-focus-arcs-3d')) {
      map.addLayer(MissileArcsLayer);
    }
    
    // Projection/terrain
    CURRENT_PROJECTION='globe'; applyProjection(); ensureTerrain?.();

    // Vue initiale
    map.jumpTo({center:WORLD_CENTER, zoom:ARRIVAL_ZOOM});

    updateRotateButtonVisibility();
  });

  // Style reload
  map.on('style.load', async ()=>{
    await CountryOverlay.init(map);
    CURRENT_PROJECTION='globe';
    applyProjection(); ensureTerrain?.();
    ensureLinksLayer();

    // Constellation (source/layers) — garantir après style.load aussi
    if(!map.getSource('entity-focus')){
      map.addSource('entity-focus',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    }
    if(!map.getLayer('entity-focus-links')){
      map.addLayer({
        id:'entity-focus-links',
        type:'line',
        source:'entity-focus',
        filter:['==',['get','kind'],'edge'],
        layout:{ visibility:'none' },
        paint:{ 'line-width':2,'line-color':'#db6402','line-opacity':0.8,'line-dasharray':[1.5,1.5] }
      }, 'clusters');
    }
    if(!map.getLayer('entity-focus-point')){
      map.addLayer({
        id:'entity-focus-point',
        type:'circle',
        source:'entity-focus',
        layout:{ visibility:'none' },
        paint:{
          'circle-radius':6,
          'circle-color':'#db6402',
          'circle-stroke-width':2,
          'circle-stroke-color':'#ffffff'
        }
      }, 'clusters');
    }

    // Arcs 3D (missiles)
    if (!map.getLayer('entity-focus-arcs-3d')) {
      map.addLayer(MissileArcsLayer);
    }
    
    // Si un pays est déjà en focus, on ré-applique l’overlay
    if (CURRENT_FOCUSED_COUNTRY && window.CountryOverlay){
      await CountryOverlay.show(map, CURRENT_FOCUSED_COUNTRY);
      bringCountryOverlayToFront();
    }
  
    if(window.__lastLinksState){
      drawLinksFrom(window.__lastLinksState.id, window.__lastLinksState.links);
    }
    updateRotateButtonVisibility();
  });

  map.on('error', e=>console.error('Map error:', e && (e.error||e)));
  map.addControl(new maplibregl.NavigationControl({showCompass:false}),'top-right');

  // ========= CONTRÔLES =========
  class FilterControl{ onAdd(map){this._map=map; const g=document.createElement('div'); g.className='maplibregl-ctrl maplibregl-ctrl-group filters-ctrl';
    const btn=document.createElement('button'); btn.className='filters-btn'; btn.type='button'; btn.title='Filtres'; btn.textContent='Filtres';
    btn.addEventListener('click',()=>{const p=document.getElementById('filtersPanel'); p.style.display=(p.style.display==='none'||!p.style.display)?'block':'none';});
    document.addEventListener('click',(e)=>{const p=document.getElementById('filtersPanel'); const b=document.querySelector('.filters-btn'); if(!p||!b) return; if(p.style.display==='block' && !p.contains(e.target) && !b.contains(e.target)) p.style.display='none';});
    g.appendChild(btn); this._container=g; return g;} onRemove(){this._container.remove(); this._map=undefined;} }
  map.addControl(new FilterControl(),'top-right');

  class RotateControl{ onAdd(map){this._map=map; const g=document.createElement('div'); g.className='maplibregl-ctrl maplibregl-ctrl-group';
    const btn=document.createElement('button'); btn.id='npRotateBtn'; btn.type='button'; btn.title='Rotation automatique'; btn.textContent='🔄'; btn.addEventListener('click',npToggleRotation);
    g.appendChild(btn); this._container=g; setTimeout(()=>{__npUpdateRotateBtn(); updateRotateButtonVisibility();},0); return g;} onRemove(){this._container?.remove(); this._map=undefined;} }
  map.addControl(new RotateControl(),'top-right');

  // Helpers
  function bringClustersToFront(){ ['clusters','unclustered-point'].forEach(id=>{ if(map.getLayer(id)){try{map.moveLayer(id);}catch{}}}); if(map.getLayer('cluster-count')){try{map.moveLayer('cluster-count');}catch{}} }
  function updateMapBackgroundClass(){const mapDiv=document.getElementById('map'); if(!mapDiv) return; if(CURRENT_BASEMAP==='dark') mapDiv.classList.add('dark'); else mapDiv.classList.remove('dark');}
  window.addEventListener('load',updateMapBackgroundClass);
  window.addEventListener('load',()=>{ CURRENT_PROJECTION='globe'; const r=document.querySelector('input[name="projection"][value="globe"]'); if(r) r.checked=true; });

  document.querySelectorAll('input[name="projection"]').forEach(r=>{ r.addEventListener('change',(e)=>{ CURRENT_PROJECTION=e.target.value; applyProjection(); ensureTerrain(); updateRotateButtonVisibility();});});
  document.querySelectorAll('input[name="basemap"]').forEach(r=>{ r.addEventListener('change', (e)=>{ CURRENT_BASEMAP=e.target.value; updateMapBackgroundClass(); map.setStyle(getStyleURL(CURRENT_BASEMAP)); });});

  // ========= FILTRES (pays bbox) =========
  let countriesBbox={};
  async function loadCountries(){ try{const res=await fetch('countries-bbox.json',{cache:'no-store'}); countriesBbox=await res.json(); buildCountrySelect(); }catch(e){console.error('countries-bbox',e);} }
  function buildCountrySelect(){ const sel=document.getElementById('filterCountry'); if(!sel) return; sel.innerHTML=''; Object.keys(countriesBbox).sort((a,b)=>a.localeCompare(b)).forEach(name=>{const opt=document.createElement('option'); opt.value=name; opt.textContent=name; sel.appendChild(opt);}); }
  const countrySel=document.getElementById('filterCountry'); if(countrySel){ countrySel.addEventListener('mousedown',(e)=>{const opt=e.target; if(opt.tagName==='OPTION'){e.preventDefault(); opt.selected=!opt.selected; countrySel.dispatchEvent(new Event('change',{bubbles:true}));}});}
  function pointInBbox(lon,lat,b){const [minX,minY,maxX,maxY]=b; return lon>=minX && lon<=maxX && lat>=minY && lat<=maxY; }

  function applyFilters(){
    const q=(document.getElementById('filterQuery')?.value||'').toLowerCase().trim();
    const selected=Array.from(document.querySelectorAll('input[name="tag"]:checked')).map(i=>i.value);
    const sel=document.getElementById('filterCountry'); const selectedCountries=sel?Array.from(sel.selectedOptions).map(o=>o.value):[];
    // À compléter si tu veux filtrer les points côté source (setData) ou DOM (markers)
    console.log('TODO filters:', {q, selected, selectedCountries});
  }
  function resetFilters(){ const q=document.getElementById('filterQuery'); if(q) q.value=''; document.querySelectorAll('input[name="tag"]:checked').forEach(cb=>cb.checked=false); const sel=document.getElementById('filterCountry'); if(sel) Array.from(sel.options).forEach(o=>o.selected=false); const panel=document.getElementById('filtersPanel'); if(panel) panel.style.display='none'; map.easeTo({center:EUROPE_CENTER,zoom:DEFAULT_ZOOM,duration:600}); }
  document.getElementById('applyFilters')?.addEventListener('click',()=>{applyFilters(); document.getElementById('filtersPanel').style.display='none';});
  document.getElementById('resetFilters')?.addEventListener('click',resetFilters);
  document.getElementById('selectAllCountries')?.addEventListener('click',()=>{const sel=document.getElementById('filterCountry'); if(!sel) return; Array.from(sel.options).forEach(o=>o.selected=true);});
  document.getElementById('clearAllCountries')?.addEventListener('click',()=>{const sel=document.getElementById('filterCountry'); if(!sel) return; Array.from(sel.options).forEach(o=>o.selected=false);});

  // ========= NAVIG / PANEL =========
  function recenterEurope(){ map.easeTo({center:EUROPE_CENTER, zoom:DEFAULT_ZOOM, duration:600}); }
  function recenterWorld(opts={animate:true}){ const target={center:WORLD_CENTER, zoom:ARRIVAL_ZOOM, bearing:0, pitch:0}; if(opts&&opts.animate===false) map.jumpTo(target); else map.easeTo({...target, duration:800}); }
  document.getElementById('recenterEurope').addEventListener('click',recenterEurope);
  document.getElementById('recenterWorld').addEventListener('click',recenterWorld);

  async function openSummaryInPanel(noteId){
    const item=idToItem.get(noteId);
    const $panel=document.getElementById('notePanel');
    const $title=document.getElementById('npTitle');
    const $place=document.getElementById('npPlace');
    const $dateText=document.getElementById('npDateText');
    const $sum=document.getElementById('npSummary');
    const $md=document.getElementById('npMd');
    const $links=document.getElementById('npLinks');
    const $fit=document.getElementById('npFit');

    if(!item){
      $title.textContent=noteId; $place.textContent=''; if($dateText) $dateText.textContent='';
      document.getElementById('npRecap').innerHTML=''; $sum.innerHTML=''; $md.innerHTML=''; $links.innerHTML='';
      $panel.style.display='block'; return;
    }

    $title.textContent=item.title||noteId;
    $place.textContent=item.locationName||'';
    if($dateText) $dateText.textContent='';
    setRecapText(item.recap||'');
    $sum.innerHTML=item.summary ? renderWikiLinksInline(item.summary) : '';

    let links=[];
    try{
      const url=resolveNoteURL(noteId);
      const res=await fetch(url,{cache:'no-store'});
      if(res.ok){
        const mdRaw=await res.text();
        const {meta, body}=parseAndStripFrontMatter(mdRaw);
        let ents=Array.isArray(meta.entities)?meta.entities:[]; ents=ents.map(e=>normalizeEntityLabelToId(e)).filter(Boolean);
        if(ents.length){ renderEntityChips(ents);} else { const box=document.getElementById('npEntities'); if(box) box.innerHTML=''; }
        if($dateText && !$dateText.textContent && meta.date) $dateText.textContent=formatDateByConfig(meta.date);
        if(!document.getElementById('npRecap').innerHTML && meta.recap) setRecapText(meta.recap);
        links=extractWikiLinks(mdRaw).filter(id=>idToItem.has(id));
        $md.innerHTML=marked.parse(transformWikiLinks(body));
      }else{ $md.innerHTML=`<em style="color:#888;">Note complète indisponible (HTTP ${res.status})</em>`; }
    }catch{ $md.innerHTML=`<em style="color:#888;">Note complète indisponible</em>`; }

    if(!links.length){ $links.innerHTML='<div style="color:#888;">Aucun lien sortant</div>'; }
    else{
      $links.innerHTML=`<ul style="margin:0; padding-left:18px;">${
        links.map(lid=>{
          const it=idToItem.get(lid);
          const lbl=it?.title||lid;
          return `<li><a href="note.html?id=${encodeURIComponent(lid)}" class="internal-link">${lbl}</a></li>`;
        }).join('')
      }</ul>`;
    }

    $panel.style.display='block';
    try{ const baseW=parseInt((UI_CONFIG?.panel?.width??400),10); $panel.style.width=Math.round(baseW*1.25)+'px'; }catch{}
    try{
      if(__selectedId!=null && __selectedId!==noteId){
        map.setFeatureState({source:'notes',id:__selectedId},{selected:false});
      }
      map.setFeatureState({source:'notes',id:noteId},{selected:true});
      __selectedId=noteId;
    }catch{}

    $panel.querySelectorAll('a[href^="note.html?id="]').forEach(a=>{
      a.classList.add('internal-link');
      a.addEventListener('click',(e)=>{ e.preventDefault(); const href=a.getAttribute('href'); const id=decodeURIComponent(href.split('id=')[1]||''); if(!id) return;
        openSummaryInPanel(id);
        try{
          if(__selectedId!=null && __selectedId!==id){ map.setFeatureState({source:'notes',id:__selectedId},{selected:false}); }
          map.setFeatureState({source:'notes',id},{selected:true}); __selectedId=id;
        }catch{}
        getOutgoingLinks(id).then(lnk=>{ drawLinksFrom(id,lnk); window.__lastLinksState={id,links:lnk};
          const from=idToItem.get(id);
          if(from){ const pw=parseInt((UI_CONFIG?.panel?.width??400),10), pr=parseInt((UI_CONFIG?.panel?.marginRight??10),10); const rightPad=Math.round(pw*1.25)+pr+10;
            map.easeTo({center:[from.lon,from.lat], zoom:ARRIVAL_ZOOM, padding:{top:20,left:20,bottom:20,right:rightPad}, duration:600}); }
        });
      });
    });

    if($fit){ $fit.onclick=()=>{ const b=new maplibregl.LngLatBounds(); const from=idToItem.get(noteId); if(from) b.extend([from.lon,from.lat]); links.forEach(lid=>{const t=idToItem.get(lid); if(t) b.extend([t.lon,t.lat]);}); if(!b.isEmpty()) map.fitBounds(b,{padding:80,duration:650});}; }
    drawLinksFrom(noteId, links); window.__lastLinksState={id:noteId,links};
  }

  // ========= GESTES GLOBAUX =========
  // Click générique (cluster OU point)
  map.on('click',(e)=>{
    const hits=map.queryRenderedFeatures(e.point);
    if(!hits.length){ clearLinks?.(); return; }
    const cl=hits.find(ft=>{const p=ft&&ft.properties; return p && (p.cluster===true || p.cluster_id!=null || p.point_count!=null);});
    if(cl){ onClickAnyCluster({features:[cl]}); return; }
    const pt=hits.find(ft=>ft.layer && ft.layer.id==='unclustered-point');
    if(pt){ onClickUnclustered({features:[pt]}); return; }
    clearLinks?.();
  });

  // Curseur main si sur un point/cluster
  map.on('mousemove',(e)=>{
    const layerIds=['clusters','cluster-count','unclustered-point'].filter(id=>map.getLayer(id));
    let hits=[]; if(layerIds.length){try{hits=map.queryRenderedFeatures(e.point,{layers:layerIds});}catch{}}
    map.getCanvas().style.cursor=hits.length?'pointer':'';
  });

  // Fermer panneau (✖/Échap) + reset vue
  (function setupNotePanelClose(){
    const btn=document.getElementById('npClose'); if(!btn) return;
    const closePanel=()=>{ const panel=document.getElementById('notePanel'); if(panel) panel.style.display='none';
      try{ const baseW=parseInt((UI_CONFIG?.panel?.width??400),10); panel.style.width=baseW+'px'; }catch{}
      if(typeof clearLinks==='function') clearLinks();
      try{ map.easeTo({center:WORLD_CENTER, zoom:ARRIVAL_ZOOM, padding:{top:0,left:0,bottom:0,right:0}, duration:500}); }catch{}
    };
    btn.addEventListener('click',closePanel);
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closePanel(); });
  })();

  // Panneau "Map views"
  (function setupMapPanelToggle(){
    const panel=document.getElementById('mapPanel'), toggle=document.getElementById('mapPanelToggle'), close=document.getElementById('mapPanelClose');
    if(!panel||!toggle||!close) return;
    const show=()=>{panel.classList.remove('panel-hidden'); toggle.setAttribute('aria-expanded','true');};
    const hide=()=>{panel.classList.add('panel-hidden'); toggle.setAttribute('aria-expanded','false');};
    toggle.addEventListener('click',()=>{const opened=toggle.getAttribute('aria-expanded')==='true'; opened?hide():show();});
    close.addEventListener('click',hide);
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') hide(); });
    hide();
  })();

  // ========= INIT =========
  loadCountries();
  applyUIConfig();

  // Logs utiles
  map.on('load',()=>console.log('[OK] map load'));
  map.on('style.load',()=>console.log('[OK] style load'));
  setTimeout(()=>console.log('[CHK] source notes =', !!map.getSource('notes')),1500);
  </script>
</body>
</html>
